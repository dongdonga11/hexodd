<!DOCTYPE html>
<html lang="zh-CN">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
  
  <title>Android逆向-某麦网APK抢票接口加密参数分析 | 栋栋的个人博客</title>
  
  <meta name="author" content="John DD" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="APP逆向, android逆向, 大麦网抢票, 逆向" />
  
  <meta name="description" content="一、前言针对某麦网部分演唱会门票仅能在app渠道抢票的问题，本文研究了APK的抢票接口并编写了抢票工具。本文介绍的顺序为环境搭建、抓包、trace分析、接口参数获取、rpc调用实现，以及最终的功能实现。通过阅读本文，你将学到反抓包技术破解、Frida hook、jadx apk逆向技术，并能对淘系APP的运行逻辑有所了解。本文仅用于学习交流，严禁用于非法用途。 关键词：frida, damai.c">
<meta property="og:type" content="article">
<meta property="og:title" content="Android逆向-某麦网APK抢票接口加密参数分析">
<meta property="og:url" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/Android%E9%80%86%E5%90%91-%E6%9F%90%E9%BA%A6%E7%BD%91APK%E6%8A%A2%E7%A5%A8%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="栋栋的个人博客">
<meta property="og:description" content="一、前言针对某麦网部分演唱会门票仅能在app渠道抢票的问题，本文研究了APK的抢票接口并编写了抢票工具。本文介绍的顺序为环境搭建、抓包、trace分析、接口参数获取、rpc调用实现，以及最终的功能实现。通过阅读本文，你将学到反抓包技术破解、Frida hook、jadx apk逆向技术，并能对淘系APP的运行逻辑有所了解。本文仅用于学习交流，严禁用于非法用途。 关键词：frida, damai.c">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/img/640-1695709905537-127-1696662606113-4.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905538-129.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905538-130.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905538-131.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905538-133.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905538-134.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905538-135.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-136.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-137.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-138.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-139.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-140.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-141.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710781461-184.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710830581-188.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-142.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710854410-191.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710869889-194.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710884589-197.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-143.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710902075-200.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710924419-203.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695709905539-144.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695710996524-206.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695711024923-209.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695711036345-212.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695711055192-215.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695711068918-218.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695711086636-221.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695711110159-224.png">
<meta property="article:published_time" content="2023-09-27T00:33:49.000Z">
<meta property="article:modified_time" content="2023-10-07T08:01:00.716Z">
<meta property="article:author" content="John DD">
<meta property="article:tag" content="逆向">
<meta property="article:tag" content="APP逆向">
<meta property="article:tag" content="android逆向">
<meta property="article:tag" content="大麦网抢票">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/img/640-1695709905537-127-1696662606113-4.png">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                        
                                            <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
                                        
                                    
                                        
                                            <li><a href="/archives/"><i class="fa fa-file"></i>档案馆</a></li>
                                        
                                    
                                        
                                            <li><a href="/friends/"><i class="fa fa-paw"></i>好伙伴</a></li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-link"></i>链接</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">栋栋的个人博客</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>栋栋的个人博客</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/Android%E9%80%86%E5%90%91-%E6%9F%90%E9%BA%A6%E7%BD%91APK%E6%8A%A2%E7%A5%A8%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">Android逆向-某麦网APK抢票接口加密参数分析</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-09-27T00:33:49.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-09-27</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">John DD</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~19.75K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1696665660716"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><p>针对某麦网部分演唱会门票仅能在app渠道抢票的问题，本文研究了APK的抢票接口并编写了抢票工具。本文介绍的顺序为环境搭建、抓包、trace分析、接口参数获取、rpc调用实现，以及最终的功能实现。通过阅读本文，你将学到反抓包技术破解、Frida hook、jadx apk逆向技术，并能对淘系APP的运行逻辑有所了解。本文仅用于学习交流，严禁用于非法用途。</p>
<p>关键词：frida, damai.cn, Android逆向<br>先放成功截图：<img src="/./../../img/img/640-1695709905537-127-1696662606113-4.png" alt="图片"></p>
<h3 id="二、环境搭建"><a href="#二、环境搭建" class="headerlink" title="二、环境搭建"></a>二、环境搭建</h3><p>目前Android模拟器竞品很多，选择Bluestacks <strong>5</strong>是因为它能和windows的hyper-v完美兼容，root过程也相对简单。</p>
<ol>
<li><p>下载安装Bluestacks。</p>
</li>
<li><p>运行Bluestacks Multi-instance Manager，发现默认安装的版本为Android Pie 64bit版本，即Android 9.0。此时退出bluestack所有程序。<br><img src="/./../../img/640-1695709905538-129.png" alt="图片"></p>
</li>
<li><p>关闭bluestack后编辑bluestacks配置文件， <code>%programdata%\BlueStacks_nxt\bluestacks.conf</code><br>&gt; 由于作者安装时C盘空间不足，真实的<code>bluestacks.conf</code>在<code>D:\BlueStacks_nxt\bluestacks.conf</code>，大家也根据实际情况调整<br><img src="/./../../img/640-1695709905538-130.png" alt="图片"></p>
</li>
<li><p>在配置文件中查找root关键词，对应值修改为1，共两处。</p>
<pre class="line-numbers language-none"><code class="language-none">bst.feature.rooting&#x3D;&quot;1&quot;
bst.instance.Pie64.enable_root_access&#x3D;&quot;1&quot;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>启动bluestack模拟器，安装 <code>Root Checker</code> APP，点击验证root，即可发现root已开启<img src="/./../../img/640-1695709905538-131.png" alt="图片"></p>
</li>
</ol>
<h3 id="三、adb调试"><a href="#三、adb调试" class="headerlink" title="三、adb调试"></a>三、adb调试</h3><ol>
<li>bluestack设置-高级中打开Adb调试，并记录下端口</li>
</ol>
<p><img src="/./../../img/640-1695709905538-133.png" alt="图片"></p>
<ol>
<li>打开主机命令行，运行 <code>adb connect localhost:6652</code>，端口号修改为上一步的端口号，即可连接。再运行<code>adb devices</code>，如有对应设备则连接成功。</li>
<li>进入adb shell，执行su进入root权限，命令行标识由<code>$</code>变为<code>#</code>，即表示adb 进入root权限成功</li>
</ol>
<p>frida环境</p>
<p>frida是大名鼎鼎的动态分析的hook神器，用它可以直接访问修改二进制的内存、函数和对象，非常方便。它对于Android的支持也是很完美。</p>
<p>frida的运行采用C&#x2F;S架构，客户端为电脑端的开发环境，服务器端为Android，均需对应部署搭建。</p>
<h3 id="客户端环境搭建-Windows"><a href="#客户端环境搭建-Windows" class="headerlink" title="客户端环境搭建(Windows)"></a>客户端环境搭建(Windows)</h3><p>firda客户端基于python3开发，因此首先需要配置好python3的运行环境，然后执行 <code>pip install frida-tools</code>即可完成安装。运行 <code>frida --version</code>可验证frida版本。</p>
<pre class="line-numbers language-none"><code class="language-none">(py3) PS E:\TEMP\damai&gt; frida --version
16.0.19<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="服务器-环境搭建-Android"><a href="#服务器-环境搭建-Android" class="headerlink" title="服务器 环境搭建(Android)"></a>服务器 环境搭建(Android)</h3><p>环境搭建第二步是在Android模拟器中运行frida-server。这样可以让Frida通过ADB&#x2F;USB调试与我们的Android模拟器连接。</p>
<ol>
<li>下载frida-server<br>最新的frida-server可以从 <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">https://github.com/frida/frida/releases</a> 下载。请注意下载与设备匹配的架构。如果您的模拟器是x86_64，请下载相应版本的frida-server。本文使用的版本为 frida-server-16.0.18-android-x86_64.xz<br><img src="/./../../img/640-1695709905538-134.png" alt="图片"></li>
<li>传入Android模拟器。</li>
</ol>
<p>将下载后的.xz文件解压，将<code>frida-server</code>传入Android模拟器</p>
<pre class="line-numbers language-none"><code class="language-none">adb push frida-server &#x2F;data&#x2F;local&#x2F;tmp&#x2F;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>运行 frida-server</li>
</ol>
<p>使用adb root以root模式重新启动ADB，并通过adb shell重新进入shell的访问。进入shell后，进入我们放置frida-server的目录并为其授予执行权限：</p>
<pre class="line-numbers language-none"><code class="language-none">cd &#x2F;data&#x2F;local&#x2F;tmp&#x2F;
chmod +x frida-server<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>执行：<code>./frida-server </code>，运行frida-server，并保持本shell窗口开启。</p>
<p>成功截图：</p>
<p><img src="/./../../img/640-1695709905538-135.png" alt="图片"></p>
<blockquote>
<p>有些情况下，应用程序会检测在是否在模拟器中运行，但对某麦网app的分析暂无影响。</p>
</blockquote>
<ol>
<li>测试是否连接成功</li>
</ol>
<p>在window端运行frida-ps命令：</p>
<p><img src="/./../../img/640-1695709905539-136.png" alt="图片"></p>
<p>看到一堆熟悉的Android进程，我们就连接成功啦</p>
<ol>
<li>转发frida-server端口 (可选)</li>
</ol>
<p>frida-server跑在Android端，frida需要通过连接frida-server。上一步使用adb的方式连接，frida认为是USB模式，需要<code>-U</code>命令。frida也支持依赖端口的远程连接模式，在某些场景下更加灵活。可以通过端口转发的方式实现此功能。</p>
<pre class="line-numbers language-none"><code class="language-none">adb forward tcp:27042 tcp:27042
adb forward tcp:27043 tcp:27043<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>抓包</p>
<h3 id="1-搞定tcpdump"><a href="#1-搞定tcpdump" class="headerlink" title="1. 搞定tcpdump"></a>1. 搞定tcpdump</h3><p>本文基于termux安装使用tcpdump。</p>
<p>首先安装termux apk。</p>
<p><img src="/./../../img/640-1695709905539-137.png" alt="图片"></p>
<p>打开termux运行：</p>
<ul>
<li>挂载存储</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">termux-setup-storage
## 会弹出授权框，点允许
ls ~&#x2F;storage&#x2F;
## 如果出现dcim, downloads等目录，即表示成功<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>安装tcpdump</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">pkg install root-repo
pkg install sudo tcpdump<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>运行抓包</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">sudo tcpdump -i any -s 0 -w ~&#x2F;storage&#x2F;downloads&#x2F;capture.pcap<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>tcpdump 成功截图:<br><img src="/./../../img/640-1695709905539-138.png" alt="图片"></li>
</ul>
<p>之后就可以把downloads目录下的抓包文件拷贝到电脑上，用wireshark打开做进一步分析。</p>
<h3 id="2-解密https流量"><a href="#2-解密https流量" class="headerlink" title="2. 解密https流量"></a>2. 解密https流量</h3><p>Wireshark解密https流量的方法和原理介绍有很多，可参考以下文章，本文不再赘述。</p>
<blockquote>
<ul>
<li><a target="_blank" rel="noopener" href="https://unit42.paloaltonetworks.com/wireshark-tutorial-decrypting-https-traffic/">https://unit42.paloaltonetworks.com/wireshark-tutorial-decrypting-https-traffic/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36669377">https://zhuanlan.zhihu.com/p/36669377</a></li>
</ul>
</blockquote>
<p>wireshark解密技术的重点在于拿到客户端通信的密钥日志文件(ssl key log)，像下面这种：</p>
<p><img src="/./../../img/640-1695709905539-139.png" alt="图片"></p>
<p>在Android中实现抓取ssl key log需要hook系统的SSL相关函数，可以用frida实现。</p>
<ul>
<li>首先将下面的hook代码保存为<code>sslkeyfilelog.js</code></li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; sslkeyfilelog.js
function startTLSKeyLogger(SSL_CTX_new, SSL_CTX_set_keylog_callback) &#123;
    console.log(&quot;start----&quot;)
    function keyLogger(ssl, line) &#123;
        console.log(new NativePointer(line).readCString());
    &#125;
    const keyLogCallback &#x3D; new NativeCallback(keyLogger, &#39;void&#39;, [&#39;pointer&#39;, &#39;pointer&#39;]);

    Interceptor.attach(SSL_CTX_new, &#123;
        onLeave: function(retval) &#123;
            const ssl &#x3D; new NativePointer(retval);
            const SSL_CTX_set_keylog_callbackFn &#x3D; new NativeFunction(SSL_CTX_set_keylog_callback, &#39;void&#39;, [&#39;pointer&#39;, &#39;pointer&#39;]);
            SSL_CTX_set_keylog_callbackFn(ssl, keyLogCallback);
        &#125;
    &#125;);
&#125;
startTLSKeyLogger(
    Module.findExportByName(&#39;libssl.so&#39;, &#39;SSL_CTX_new&#39;),
    Module.findExportByName(&#39;libssl.so&#39;, &#39;SSL_CTX_set_keylog_callback&#39;)
)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>然后用frida加载运行hook</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">frida -U -l .\sslkeyfilelog.js  -f cn.damai<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/./../../img/640-1695709905539-140.png" alt="图片"></p>
<ul>
<li>最后，抓包结束后将得到的key保存到sslkey.txt，格式是下面这样的，不要掺杂别的。</li>
</ul>
<pre class="line-numbers language-none"><code class="language-none">CLIENT_RANDOM 557e6dc49faec93dddd41d8c55d3a0084c44031f14d66f68e3b7fb53d3f9586d 886de4677511305bfeaee5ffb072652cbfba626af1465d09dc1f29103fd947c997f6f28962189ee809944887413d8a20
CLIENT_RANDOM e66fb5d6735f0b803426fa88c3692e8b9a1f4dca37956187b22de11f1797e875 65a07797c144ecc86026a44bbc85b5c57873218ce5684dc22d4d4ee9b754eb1961a0789e2086601f5b0441c35d76c448<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>在运行Frida Hook获取sslkey的同时，运行tcpdump抓包。抓包中依次测试获取详情页、选择价位、提交订单等操作，并对应记录下执行操作的时间，方便后续分析。</p>
<p>抓包完成后，用wireshark打开tcpdump抓包获得的pcap文件，在wireshark首选项-protocols-TLS中，设置 (Pre)-Master-Secret log filename为上述sslkey.txt。</p>
<p><img src="/./../../img/640-1695709905539-141.png" alt="图片"></p>
<p>即可实现https流量的解密。</p>
<p>流量分析</p>
<h3 id="某麦网的API流"><a href="#某麦网的API流" class="headerlink" title="某麦网的API流"></a>某麦网的API流</h3><p>在此铺垫一下，通过前期对某麦网PC端和移动端H5的分析，某麦网购票的工作流程大概为：</p>
<ol>
<li>获得详情：接口为<code>mtop.alibaba.damai.detail.getdetail</code>。基于某演出的id(itemId)获得演出的详细信息，包括详情、场次、票档(SkuId)价位及状态信息，</li>
<li>构建订单：接口为<code>mtop.trade.order.build.h5</code>。发送 演出id+数量+票档id(<code>itemId_count_skuId</code>)，得到提交订单所需的表单信息，包括观众、收货地址等。</li>
<li>提交订单：接口为<code>mtop.trade.order.create.h5</code>。对上一步构建订单得到的表单参数作出修改后，发送给服务器，得到最后的订单提交结果和支付信息。</li>
</ol>
<h3 id="apk流量分析"><a href="#apk流量分析" class="headerlink" title="apk流量分析"></a>apk流量分析</h3><p>首先用过滤器<code>http &amp;&amp; tcp.dstport==443</code>，得到向服务器发送的https包，如下图：</p>
<p><img src="/./../../img/640-1695710781461-184.png" alt="图片"></p>
<p>可以看到大量向服务器请求的数据包，但其中有很多干扰的图片请求，因为修改过滤器把图片过滤一下。过滤器：<code>http &amp;&amp; tcp.dstport==443 and !(http.request.uri contains &quot;.webp&quot; or http.request.uri contains &quot;.jpg&quot; or http.request.uri contains &quot;.png&quot;)</code></p>
<p>结果清爽了很多。</p>
<h4 id="订单构建-order-build"><a href="#订单构建-order-build" class="headerlink" title="订单构建(order.build)"></a>订单构建(order.build)</h4><p>根据之前记录的操作的时间，以及对网页版的分析结果，笔者注意到了下图的这条流量：</p>
<p><img src="/./../../img/640-1695710830581-188.png" alt="图片"></p>
<p>然后我们右键选择这条流量包，点击追踪http流，可以看到对应的响应包。</p>
<p><img src="/./../../img/640-1695709905539-142.png" alt="图片"></p>
<p><img src="/./../../img/640-1695710854410-191.png" alt="图片"></p>
<p>响应包里有些中文使用了UTF-8编码，可以点击右下角的<code>Show data as</code>，选择UTF-8，便可以正常显示。此时可以点击另存为，保存为txt文件，方便后续分析。</p>
<p><img src="/./../../img/640-1695710869889-194.png" alt="图片"></p>
<p>订单构建的请求包中核心的数据部分为图中青色圈出来的部分，使用URL解码后为：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;buyNow&quot;:&quot;true&quot;,&quot;buyParam&quot;:&quot;716435462268_2_5005943905715&quot;,&quot;exParams&quot;:&quot;&#123;\&quot;atomSplit\&quot;:\&quot;1\&quot;,\&quot;channel\&quot;:\&quot;damai_app\&quot;,\&quot;coVersion\&quot;:\&quot;2.0\&quot;,\&quot;coupon\&quot;:\&quot;true\&quot;,\&quot;seatInfo\&quot;:\&quot;\&quot;,\&quot;umpChannel\&quot;:\&quot;10001\&quot;,\&quot;websiteLanguage\&quot;:\&quot;zh_CN_#Hans\&quot;&#125;&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>buyParam为最核心的部分，拼接方式为演出id+数量+票档id。其他部分只需照抄。</p>
<p>请求包中还包含大量的各种加密参数、ID，而破解实现自动购票脚本的关键就在于如何通过代码的方式拿到这些加密参数。</p>
<p>订单构建的响应包为订单提交表单的各项参数，用于生成“确认订单”的表单。</p>
<p><img src="/./../../img/640-1695710884589-197.png" alt="图片"></p>
<p><img src="/./../../img/640-1695709905539-143.png" alt="图片"></p>
<h4 id="订单提交-order-create"><a href="#订单提交-order-create" class="headerlink" title="订单提交(order.create)"></a>订单提交(order.create)</h4><p>按照同样的方式可以找到订单提交包，订单提交包的API路径为<code>/gw/mtop.trade.order.create</code>，</p>
<p><img src="/./../../img/640-1695710902075-200.png" alt="图片"></p>
<p>其中青色圈出来的部分为data发送的核心数据，对数据用URL解码后为：</p>
<pre class="line-numbers language-none"><code class="language-none">&#123;&quot;feature&quot;:&quot;&#123;\&quot;gzip\&quot;:\&quot;true\&quot;&#125;&quot;,&quot;params&quot;:&quot;H4sIAAAAAAA.................AAWk3NKAAA\n&quot;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>看起来像是把原始数据用gzip压缩后又使用了base64编码，尝试解码：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64
<span class="token keyword">import</span> gzip
<span class="token keyword">import</span> json

<span class="token comment"># 解码后变为python dict</span>
decode_data<span class="token operator">=</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>params_str<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"\\n"</span><span class="token punctuation">,</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
decompressed_data<span class="token operator">=</span>gzip<span class="token punctuation">.</span>decompress<span class="token punctuation">(</span>decode_data<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>
params<span class="token operator">=</span>json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>decompressed_data<span class="token punctuation">)</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"reverse\order.create-params.json"</span><span class="token punctuation">,</span><span class="token string">"w"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
    json<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>params<span class="token punctuation">,</span>f<span class="token punctuation">,</span>indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>解码成功，存到<code>order.create-params.json</code>,</p>
<p><img src="/./../../img/640-1695710924419-203.png" alt="图片"></p>
<p>解码后发现order.create发送的data参数和order.build请求返回的结果很相似，增加了一些用户对表单操作的记录。</p>
<p><img src="/./../../img/640-1695709905539-144.png" alt="图片"></p>
<p>order.create请求的header中的各种加密参数和order.build一致。</p>
<p>order.create请求的返回结果中包含了订单创建是否成功的结果以及支付链接.</p>
<p>TRACE分析</p>
<p>通过前面对流量的分析，我们已经知道客户端向服务器发送的核心数据和加密参数，核心数据的拼接相对简单，但加密参数怎么获得还比较困难。因此，下面要开始分析加密参数的生成方法。本章节主要采用frida trace动态分析和jadx静态分析相结合的方式，旨在找到加密参数生成的核心函数和输入输出数据的格式。</p>
<p>根据文章 ( app安卓逆向x-sign，x-sgext，x_mini_wua，x_umt加密参数解析 )，其中数据包的加密参数和本文的某麦网很类似，而且提到了 mtopsdk.security.InnerSignImpl 生成的加密函数，本文也参考了这篇文章的思路进行分析。</p>
<h2 id="跟踪-InnerSignImpl"><a href="#跟踪-InnerSignImpl" class="headerlink" title="跟踪 InnerSignImpl"></a>跟踪 InnerSignImpl</h2><p>运行<code>frida-trace -U -j &quot;*InnerSignImpl*!*&quot; 大麦</code>，执行选座提交订单的操作，发现确实有结果输出：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> PS E:<span class="token punctuation">\</span>TEMP<span class="token punctuation">\</span>damai<span class="token operator">></span> frida-trace <span class="token parameter variable">-U</span> <span class="token parameter variable">-j</span> <span class="token string">"*InnerSignImpl*!*"</span> 大麦
Instrumenting<span class="token punctuation">..</span>.
InnerSignImpl<span class="token variable">$1</span><span class="token builtin class-name">.</span><span class="token variable">$init</span><span class="token builtin class-name">:</span> Loaded handler at <span class="token string">"E:<span class="token entity" title="\\">\\</span>TEMP<span class="token entity" title="\\">\\</span>damai<span class="token entity" title="\\">\\</span>__handlers__<span class="token entity" title="\\">\\</span>mtopsdk.security.InnerSignImpl_1<span class="token entity" title="\\">\\</span>_init.js"</span>
<span class="token punctuation">..</span><span class="token punctuation">..</span>此处省略<span class="token punctuation">..</span>.
InnerSignImpl.init: Loaded handler at <span class="token string">"E:<span class="token entity" title="\\">\\</span>TEMP<span class="token entity" title="\\">\\</span>damai<span class="token entity" title="\\">\\</span>__handlers__<span class="token entity" title="\\">\\</span>mtopsdk.security.InnerSignImpl<span class="token entity" title="\\">\\</span>init.js"</span>
Started tracing <span class="token number">27</span> functions. Press Ctrl+C to stop.
           /* TID 0x144f */
  <span class="token number">6725</span> ms  InnerSignImpl.getUnifiedSign<span class="token punctuation">(</span><span class="token string">"&lt;instance: java.util.HashMap>"</span>, <span class="token string">"&lt;instance: java.util.HashMap>"</span>, <span class="token string">"23781390"</span>, null, <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token number">6726</span> ms     <span class="token operator">|</span> InnerSignImpl.convertInnerBaseStrMap<span class="token punctuation">(</span><span class="token string">"&lt;instance: java.util.Map, <span class="token variable">$className</span>: java.util.HashMap>"</span>, <span class="token string">"23781390"</span>, <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token number">6726</span> ms     <span class="token operator">|</span> <span class="token operator">&lt;=</span> <span class="token string">"&lt;instance: java.util.Map, <span class="token variable">$className</span>: java.util.HashMap>"</span>
  <span class="token number">6727</span> ms     <span class="token operator">|</span> InnerSignImpl.getMiddleTierEnv<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token number">6727</span> ms     <span class="token operator">|</span> <span class="token operator">&lt;=</span> <span class="token number">0</span>
  <span class="token number">6737</span> ms  <span class="token operator">&lt;=</span> <span class="token string">"&lt;instance: java.util.HashMap>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>点击发送请求时，调用了InnerSignImpl.getUnifiedSign函数。但是输入参数和数据参数均为HashMap类型，结果中未显示具体内容。从结果输出中猜测frida-trace是通过对需要hook的函数在__handlers__下生成js文件，并调用js文件进行hook操作的，因此笔者修改了“handlers\mtopsdk.security.InnerSignImpl\getUnifiedSign.js”，使其能正确输出HashMap类型。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// __handlers__<span class="token punctuation">\</span>mtopsdk.security.InnerSignImpl<span class="token punctuation">\</span>getUnifiedSign.js

<span class="token punctuation">&#123;</span>onEnter<span class="token punctuation">(</span>log, args, state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 // 增加了HashMap2Str函数，将HashMap类型转换为字符串
    <span class="token keyword">function</span> HashMap2Str<span class="token punctuation">(</span>params_hm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      var <span class="token assign-left variable">HashMap</span><span class="token operator">=</span>Java.use<span class="token punctuation">(</span><span class="token string">'java.util.HashMap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      var <span class="token assign-left variable">args_map</span><span class="token operator">=</span>Java.cast<span class="token punctuation">(</span>params_hm,HashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token builtin class-name">return</span> args_map.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
     // 当调用函数时，输出函数参数
    log<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span>InnerSignImpl.getUnifiedSign<span class="token punctuation">(</span>$<span class="token punctuation">&#123;</span>HashMap2Str<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>,$<span class="token punctuation">&#123;</span>HashMap2Str<span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span>,$<span class="token punctuation">&#123;</span>args<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>,$<span class="token punctuation">&#123;</span>args<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token variable">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>, onLeave<span class="token punctuation">(</span>log, retval, state<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">function</span> HashMap2Str<span class="token punctuation">(</span>params_hm<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        var <span class="token assign-left variable">HashMap</span><span class="token operator">=</span>Java.use<span class="token punctuation">(</span><span class="token string">'java.util.HashMap'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var <span class="token assign-left variable">args_map</span><span class="token operator">=</span>Java.cast<span class="token punctuation">(</span>params_hm,HashMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> args_map.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">!=</span><span class="token operator">=</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
     // 当函数运行结束时，输出函数结果
      log<span class="token punctuation">(</span><span class="token variable"><span class="token variable">`</span><span class="token operator">&lt;=</span> $<span class="token punctuation">&#123;</span>HashMap2Str<span class="token punctuation">(</span>retval<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token variable">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再次运行frida-trace，输出的结果已经可以看到具体内容了：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">(</span>py3<span class="token punctuation">)</span> PS E:<span class="token punctuation">\</span>TEMP<span class="token punctuation">\</span>damai<span class="token operator">></span> frida-trace <span class="token parameter variable">-U</span> <span class="token parameter variable">-j</span> <span class="token string">"*InnerSignImpl*!*"</span> 大麦
        <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
Started tracing <span class="token number">27</span> functions. Press Ctrl+C to stop.
           /* TID 0x15ab */
  <span class="token number">2653</span> ms  InnerSignImpl.getUnifiedSign<span class="token punctuation">(</span><span class="token punctuation">&#123;</span>data<span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"itemId"</span><span class="token builtin class-name">:</span><span class="token string">"719193771661"</span>,<span class="token string">"performId"</span><span class="token builtin class-name">:</span><span class="token string">"211232892"</span>,<span class="token string">"skuParamListJson"</span><span class="token builtin class-name">:</span><span class="token string">"[&#123;<span class="token entity" title="\&quot;">\"</span>count<span class="token entity" title="\&quot;">\"</span>:1,<span class="token entity" title="\&quot;">\"</span>price<span class="token entity" title="\&quot;">\"</span>:36000,<span class="token entity" title="\&quot;">\"</span>priceId<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>251592963<span class="token entity" title="\&quot;">\"</span>&#125;]"</span>,<span class="token string">"dmChannel"</span><span class="token builtin class-name">:</span><span class="token string">"*@damai_android_*"</span>,<span class="token string">"channel_from"</span><span class="token builtin class-name">:</span><span class="token string">"damai_market"</span>,<span class="token string">"appType"</span><span class="token builtin class-name">:</span><span class="token string">"1"</span>,<span class="token string">"osType"</span><span class="token builtin class-name">:</span><span class="token string">"2"</span>,<span class="token string">"calculateTag"</span><span class="token builtin class-name">:</span><span class="token string">"0_0_0_0"</span>,<span class="token string">"source"</span><span class="token builtin class-name">:</span><span class="token string">"10101"</span>,<span class="token string">"version"</span><span class="token builtin class-name">:</span><span class="token string">"6000168"</span><span class="token punctuation">&#125;</span>, <span class="token assign-left variable">deviceId</span><span class="token operator">=</span>null, <span class="token assign-left variable">sid</span><span class="token operator">=</span>13abe677c5076a4fa3382afc38a96a04, <span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">2215803849550</span>, x-features<span class="token operator">=</span><span class="token number">27</span>, <span class="token assign-left variable">appKey</span><span class="token operator">=</span><span class="token number">23781390</span>, <span class="token assign-left variable">api</span><span class="token operator">=</span>mtop.damai.item.calcticketprice, <span class="token assign-left variable">utdid</span><span class="token operator">=</span>ZF3KUN8khtQDAIlImefp4RYz, <span class="token assign-left variable">ttid</span><span class="token operator">=</span><span class="token number">10005890</span>@damai_android_8.5.4, <span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token number">1684828096</span>, <span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token number">2.0</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span>pageId<span class="token operator">=</span>, <span class="token assign-left variable">pageName</span><span class="token operator">=</span><span class="token punctuation">&#125;</span>,23781390,null<span class="token punctuation">)</span>
  <span class="token number">2654</span> ms     <span class="token operator">|</span> InnerSignImpl.convertInnerBaseStrMap<span class="token punctuation">(</span><span class="token string">"&lt;instance: java.util.Map, <span class="token variable">$className</span>: java.util.HashMap>"</span>, <span class="token string">"23781390"</span>, <span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token number">2655</span> ms     <span class="token operator">|</span> <span class="token operator">&lt;=</span> <span class="token string">"&lt;instance: java.util.Map, <span class="token variable">$className</span>: java.util.HashMap>"</span>
  <span class="token number">2655</span> ms     <span class="token operator">|</span> InnerSignImpl.getMiddleTierEnv<span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token number">2655</span> ms     <span class="token operator">|</span> <span class="token operator">&lt;=</span> <span class="token number">0</span>
  <span class="token number">2662</span> ms  <span class="token operator">&lt;=</span> <span class="token punctuation">&#123;</span>x-sgext<span class="token operator">=</span>JA2qmBOxRVDxFRzca3r9BZibqJqvn7uerZOriayYu4mpnKCeoJiunKGZu5qqyfmaqJqhmvqYr5n8zPyJqImpmbvLrImomqidu5m7m7uYu5u7mLuYu5u7m7ubqYmtiaiJqImoiaiJqImoiaiJu8+7iaCf/cypnruaqJqomruau5j8y7uau4mgiaiJqInf6fDIu5o<span class="token operator">=</span>, x-umt<span class="token operator">=</span>+D0B/05LPEvOgwKIQ1x+SeV5wNE6NzOo, x-mini-wua<span class="token operator">=</span>atASnVJw3vGX1Tw3Y/zDaVZkDUbLxOxtlUmgDOnIjMTBcMPMqQJLpnxoOWEL53Fq/OPcQZiMpDXWNvDz8UQkI5mtkZvIcDN1oxZnuH0M22LHKar4rnO/xm4LtAiniKgYtfgMGK3stXuCmvtE4raIhROimslSk7hCkxaL/DYuLzBLYwXmNyr9UZi1g, x-sign<span class="token operator">=</span>azG34N002xAAK0H9KwNr3txWFMxzW0H7ROfkLQK+Db7ueJHktR/yP/0TcdPFzoYf36zd9lJYMsHCmYX3EcoFnJPMk2pxu0H7QbtB+0<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>可以看到返回结果中包含了 <code>x-sgext</code>,<code>x-umt</code>,<code>x-mini-wua</code>,<code>x-sign</code> 等加密参数。至此，前面的一大堆分析也算有了小的收获。但对比流量分析结果中的发送参数，还是缺失了很多参数。下面我们继续跟踪，找出剩下的参数。</p>
<h2 id="跟踪-mtopsdk"><a href="#跟踪-mtopsdk" class="headerlink" title="跟踪 mtopsdk"></a>跟踪 mtopsdk</h2><p>调研发现淘系的apk都包含mtopsdk，猜想会不会有公开的官方文档描述mtopsdk的使用方法，因此我们就找到了 【阿里云mtopsdk Android接入文档】 。其中介绍了请求构建的流程为，笔者重点关注了请求构建和发送的部分：</p>
<pre class="line-numbers language-none"><code class="language-none">&#x2F;&#x2F; 3. 请求构建
&#x2F;&#x2F; 3.1生成MtopRequest实例
MtopRequest request &#x3D; new MtopRequest();
&#x2F;&#x2F; 3.2 生成MtopBuilder实例
MtopBuilder builder &#x3D; instance.build(MtopRequest request, String ttid);
&#x2F;&#x2F; 4. 请求发送
&#x2F;&#x2F; 4.2 异步调用
ApiID apiId &#x3D; builder.addListener(new MyListener).asyncRequest();<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因此我们不妨大胆一些，直接跟踪所有对mtopsdk中函数的调用。</p>
<pre class="line-numbers language-none"><code class="language-none">(py3) PS E:\TEMP\damai&gt; frida-trace -U -j &quot;*mtopsdk*!*&quot; 大麦<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p><img src="/./../../img/640-1695710996524-206.png" alt="图片"></p>
<p>输出的结果大概有2000行，直接看太费劲，我们复制到文本编辑器里做进一步分析。</p>
<p>我们按照阿里的官方文档介绍的流程，对应可以找到在输出的trace中找到一些关键的日志。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># MtopRequest初始化</span>
  <span class="token number">3249</span> ms  MtopRequest.<span class="token variable">$init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token number">3249</span> ms  MtopRequest.setApiName<span class="token punctuation">(</span><span class="token string">"mtop.trade.order.build"</span><span class="token punctuation">)</span>
  <span class="token number">3249</span> ms  MtopRequest.setVersion<span class="token punctuation">(</span><span class="token string">"4.0"</span><span class="token punctuation">)</span>
  <span class="token number">3249</span> ms  MtopRequest.setNeedSession<span class="token punctuation">(</span>true<span class="token punctuation">)</span>
  <span class="token number">3249</span> ms  MtopRequest.setNeedEcode<span class="token punctuation">(</span>true<span class="token punctuation">)</span>
  <span class="token number">3249</span> ms  MtopRequest.setData<span class="token punctuation">(</span><span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>buyNow<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>true<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>buyParam<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>7191937661_1_51826442779<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>exParams<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>&#123;<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>atomSplit<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>1<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>channel<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>damai_app<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>coVersion<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>2.0<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>coupon<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>true<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>seatInfo<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>umpChannel<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>10001<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>websiteLanguage<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>zh_CN_#Hans<span class="token entity" title="\\">\\</span><span class="token entity" title="\&quot;">\"</span>&#125;<span class="token entity" title="\&quot;">\"</span>&#125;"</span><span class="token punctuation">)</span>

<span class="token comment"># MtopBuilder初始化</span>
  <span class="token number">3251</span> ms  MtopBuilder.<span class="token variable">$init</span><span class="token punctuation">(</span><span class="token string">"&lt;instance: mtopsdk.mtop.intf.Mtop>"</span>, <span class="token string">"&lt;instance: mtopsdk.mtop.domain.MtopRequest>"</span>, null<span class="token punctuation">)</span>

<span class="token comment"># MtopBuilder发送异步请求</span>
<span class="token number">3268</span> ms  MtopBuilder.asyncRequest<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 参数构建</span>
<span class="token number">3301</span> ms     <span class="token operator">|</span>    <span class="token operator">|</span>    <span class="token operator">|</span> InnerProtocolParamBuilderImpl.buildParams<span class="token punctuation">(</span><span class="token string">"&lt;instance: mtopsdk.framework.domain.MtopContext>"</span><span class="token punctuation">)</span>
<span class="token number">3391</span> ms     <span class="token operator">|</span>    <span class="token operator">|</span>    <span class="token operator">|</span> <span class="token operator">&lt;=</span> <span class="token string">"&lt;instance: java.util.Map, <span class="token variable">$className</span>: java.util.HashMap>"</span>,<span class="token punctuation">&#123;</span>wua<span class="token operator">=</span>CofS_+7HCuvRCdz1EN8ICI6A4ZBCJwgY1hi+Bsivjcijs8GggmUxLQQUVTEQ5mYYtPuV7R2QNG5JEONIJRfmzjxFXMrs9AHdepIuqoJJJAyewWALprRnjIAu75t47Tm/RU9xRi7IEo9w0P2aCquLzf7uhiO8JEDSRK/ZdVhURBbof7reFtzEBoYYeIPgnwz7CL3kRlbyqyJcYKxO7ZmmVq1PtMXF2HGJqRSDjdv9l4mySJljIQzBmpX393L6eO1ZQVG1fpp6RaCRcFF+UgfjJXaeMFziHzfQF7KfUQZIeAJV/4GyVEE2f55RwPluOTuQubXQnq+qu41a0V5oyEOFXMoQRYFZzLOv3CjwkiIXsqJFeIHc<span class="token operator">=</span>, x-sgext<span class="token operator">=</span>JA0VLKcO8e9Fqqhj38VJuiwkHCUbIA8jGCwUNh0mDzYdIxQhFCcVJxskDyUedk0lHCUVJU4nGyZIc0g2HDYdJg90GDYcJRwiDyYPJA8kDyQPJA8kDyQPJA8nDyQPJQ8lDyUPJQ8lDyUPJQ82STYPLRlwSiUcNhwlHCUcNhw2HnFNNhw2Dy0PJQ8lD1JvfU42HA<span class="token operator">==</span>, <span class="token assign-left variable">nq</span><span class="token operator">=</span>WIFI, <span class="token assign-left variable">data</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token string">"buyNow"</span><span class="token builtin class-name">:</span><span class="token string">"true"</span>,<span class="token string">"buyParam"</span><span class="token builtin class-name">:</span><span class="token string">"719193771661_1_5182956442779"</span>,<span class="token string">"exParams"</span><span class="token builtin class-name">:</span><span class="token string">"&#123;<span class="token entity" title="\&quot;">\"</span>atomSplit<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>1<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>channel<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>damai_app<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>coVersion<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>2.0<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>coupon<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>true<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>seatInfo<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span><span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>umpChannel<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>10001<span class="token entity" title="\&quot;">\"</span>,<span class="token entity" title="\&quot;">\"</span>websiteLanguage<span class="token entity" title="\&quot;">\"</span>:<span class="token entity" title="\&quot;">\"</span>zh_CN_#Hans<span class="token entity" title="\&quot;">\"</span>&#125;"</span><span class="token punctuation">&#125;</span>, <span class="token assign-left variable">pv</span><span class="token operator">=</span><span class="token number">6.3</span>, <span class="token assign-left variable">sign</span><span class="token operator">=</span>azG34N002xAAKiYA2sv237H04abW2iYKIxaD3GVPak+JifYV0u6VzpriFiKiP+HuuF26BzWpVTClaOIGdjtibfQ99JomGiYKJhomCi, <span class="token assign-left variable">deviceId</span><span class="token operator">=</span>null, <span class="token assign-left variable">sid</span><span class="token operator">=</span>13abe677c5076a4fa3382afc38a96a04, <span class="token assign-left variable">uid</span><span class="token operator">=</span><span class="token number">2215803849550</span>, x-features<span class="token operator">=</span><span class="token number">27</span>, x-app-conf-v<span class="token operator">=</span><span class="token number">0</span>, x-mini-wua<span class="token operator">=</span>a3gSvx5K5/NRy/W8+fDouCSQ6VSmMK3awHwo5X+IayY7JL5SwHtiL0soynSAvCobk01qRQ2fQcTvZWakhmhA9xlNOKdwvxdA5nZ4Tno2asO5e7EvSMj6yqVYAXZZUBjZPUOBw3vpH8L2GUq9Gi6MTszU57a58+hJE2BCGTVsxhRonDw1Nnxp74Ffm, <span class="token assign-left variable">appKey</span><span class="token operator">=</span><span class="token number">23781390</span>, <span class="token assign-left variable">api</span><span class="token operator">=</span>mtop.trade.order.build, <span class="token assign-left variable">umt</span><span class="token operator">=</span>+D0B/05LPEvOgwKIQ1x+SeV5wNE6NzOo, f-refer<span class="token operator">=</span>mtop, <span class="token assign-left variable">utdid</span><span class="token operator">=</span>ZF3KUN8khtQDAIlImefp4RYz, <span class="token assign-left variable">netType</span><span class="token operator">=</span>WIFI, x-app-ver<span class="token operator">=</span><span class="token number">8.5</span>.4, x-c-traceid<span class="token operator">=</span>ZF3KUN8khtQDAIlImefp4RYz1684829318230001316498, <span class="token assign-left variable">ttid</span><span class="token operator">=</span><span class="token number">10005890</span>@damai_android_8.5.4, <span class="token assign-left variable">t</span><span class="token operator">=</span><span class="token number">1684829318</span>, <span class="token assign-left variable">v</span><span class="token operator">=</span><span class="token number">4.0</span>, user-agent<span class="token operator">=</span>MTOPSDK/3.1.1.7 <span class="token punctuation">(</span>Android<span class="token punctuation">;</span><span class="token number">9</span><span class="token punctuation">;</span>samsung<span class="token punctuation">;</span>SM-S908E<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>笔者注意到了InnerProtocolParamBuilderImpl.buildParams函数的输出结果完全覆盖了需要的各类加密参数，其输入类型是MtopContext。从jadx逆向的apk代码中可以找到MtopContext类，即包含Mtop生命周期的各个类的一个容器。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MtopContext</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token class-name">ApiID</span> apiId<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> baseUrl<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">MtopBuilder</span> mtopBuilder<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Mtop</span> mtopInstance<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">MtopListener</span> mtopListener<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">MtopRequest</span> mtopRequest<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">MtopResponse</span> mtopResponse<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Request</span> networkRequest<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Response</span> networkResponse<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">MtopNetworkProp</span> property <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MtopNetworkProp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> protocolParams<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> queryParams<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseSource</span> responseSource<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> seqNo<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@NonNull</span>
    <span class="token keyword">public</span> <span class="token class-name">MtopStatistics</span> stats<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>所以现在的问题变为如何能够构建出来MtopContext，然后调用buildParams函数生成各类加密参数。</p>
<h2 id="分析业务模块与mtopsdk的交互过程"><a href="#分析业务模块与mtopsdk的交互过程" class="headerlink" title="分析业务模块与mtopsdk的交互过程"></a>分析业务模块与mtopsdk的交互过程</h2><p>在写本文复盘分析过程的时候，笔者发现仅依赖mtopsdk的调用过程其实已经可以得到MtopContext的全部生成逻辑了。但所谓当局者迷，笔者在当时分析的时候还是一头雾水。因此在此也介绍一下笔者的思考逻辑。</p>
<p>当时看着mtopsdk的调用过程，感觉很复杂。但是猜想从用户点击操作-&gt;业务代码-&gt;mtopsdk的数据流，以及模块间高内聚低耦合的原则，所以猜想模块间的调用不会很复杂，所以笔者就想分析业务代码与mtopsdk的调用逻辑。所以就想跟踪主要业务代码的trace。所以笔者继续跟踪trace，运行<code>frida-trace -U -j &quot;*cn.damai*!*&quot; 大麦 </code>，以分析<code>cn.damai</code>包的调用过程，在其中发现了 <code>NcovSkuFragment.buyNow()</code> 函数，看起来是和购买紧密相关的函数。又找到DMBaseMtopRequest类。</p>
<p><img src="/./../../img/640-1695711024923-209.png" alt="图片"></p>
<p>但是在这里有点卡住了，因为只找到了构建MtopRequest，并未在cn.damai的trace日志中并未发现其他对mtop的调用。</p>
<p>然后笔者又尝试搜索和api(order.build)相关的代码，找到了：</p>
<p><img src="/./../../img/640-1695711036345-212.png" alt="图片"></p>
<p>然而并没有多大用处。</p>
<p>然后，作者又读了大量的源代码，终于定位到了 <code>com.taobao.tao.remotebusiness.MtopBussiness</code>这个关键类。</p>
<p><img src="/./../../img/640-1695711055192-215.png" alt="图片"></p>
<p>笔者本以为com.taobao开头的代码不是那么重要，所以最开始把这个类完全忽略了。但通过对源码的阅读，发现这个类是motpsdk中MtopBuilder类的子类，主要负责管理业务代码和Mtopsdk的交互。</p>
<p>因此我们继续通过trace跟踪MtopBussiness类。运行<code>frida-trace -U -j &quot;*!*buyNow*&quot; -j &quot;com.taobao.tao.remotebusiness.MtopBusiness!*&quot; -j &quot;*MtopContext!*&quot; -j &quot;*mtopsdk.mtop.intf.MtopBuilder!*&quot; 大麦</code></p>
<p><img src="/./../../img/640-1695711068918-218.png" alt="图片"></p>
<p>现在业务代码和mtopsdk的交互就很清晰了，红色的部分是业务代码的函数，绿色的部分是mtopsdk的函数。</p>
<h1 id="0x06-hook得到接口参数"><a href="#0x06-hook得到接口参数" class="headerlink" title="0x06 hook得到接口参数"></a>0x06 hook得到接口参数</h1><p>通过以上对trace的分析，已经知道了具体执行的操作，因此我们可以使用frida编写js代码，直接调用APK中的类，实现功能调用。</p>
<p>先展示一个简单的示例，用于构建一个自定义的MtopRequest 类:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// new_request.js</span>
<span class="token class-name">Java</span><span class="token punctuation">.</span><span class="token function">perform</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">const</span> <span class="token class-name">MtopRequest</span> <span class="token operator">=</span> <span class="token class-name">Java</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">"mtopsdk.mtop.domain.MtopRequest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    let myMtopRequest <span class="token operator">=</span> <span class="token class-name">MtopRequest</span><span class="token punctuation">.</span>$<span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myMtopRequest<span class="token punctuation">.</span><span class="token function">setApiName</span><span class="token punctuation">(</span><span class="token string">"mtop.trade.order.build"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//item_id + count + ski_id  716435462268_1_5005943905715</span>
    myMtopRequest<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"&#123;\"buyNow\":\"true\",\"buyParam\":\"716435462268_1_5005943905715\",\"exParams\":\"&#123;\\\"atomSplit\\\":\\\"1\\\",\\\"channel\\\":\\\"damai_app\\\",\\\"coVersion\\\":\\\"2.0\\\",\\\"coupon\\\":\\\"true\\\",\\\"seatInfo\\\":\\\"\\\",\\\"umpChannel\\\":\\\"10001\\\",\\\"websiteLanguage\\\":\\\"zh_CN_#Hans\\\"&#125;\"&#125;"</span><span class="token punctuation">)</span>
    myMtopRequest<span class="token punctuation">.</span><span class="token function">setNeedEcode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myMtopRequest<span class="token punctuation">.</span><span class="token function">setNeedSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    myMtopRequest<span class="token punctuation">.</span><span class="token function">setVersion</span><span class="token punctuation">(</span><span class="token string">"4.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>`$<span class="token punctuation">&#123;</span>myMtopRequest<span class="token punctuation">&#125;</span>`<span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再使用运行命令 <code>frida -U -l .\reverse\new_request.js 大麦</code>，以在某麦Apk中执行js hook代码。运行之后即可输出笔者自己构建的MtopRequest实例。（frida真的很奇妙！）</p>
<p><img src="/./../../img/640-1695711086636-221.png" alt="图片"></p>
<p>有了上面的结果，下面继续完善这个示例，添加MtopBussiness的构建过程和输出过程</p>
<pre class="line-numbers language-none"><code class="language-none">       &#x2F;&#x2F;引入Java中的类
const MtopBusiness &#x3D; Java.use(&quot;com.taobao.tao.remotebusiness.MtopBusiness&quot;);
const MtopBuilder &#x3D; Java.use(&quot;mtopsdk.mtop.intf.MtopBuilder&quot;);
&#x2F;&#x2F; let RemoteBusiness &#x3D; Java.use(&quot;com.taobao.tao.remotebusiness.RemoteBusiness&quot;);
const MethodEnum &#x3D; Java.use(&quot;mtopsdk.mtop.domain.MethodEnum&quot;);
const MtopListenerProxyFactory &#x3D; Java.use(&quot;com.taobao.tao.remotebusiness.listener.MtopListenerProxyFactory&quot;);
const System &#x3D; Java.use(&#39;java.lang.System&#39;);
const ApiID &#x3D; Java.use(&quot;mtopsdk.mtop.common.ApiID&quot;);
const MtopStatistics &#x3D; Java.use(&quot;mtopsdk.mtop.util.MtopStatistics&quot;);
const InnerProtocolParamBuilderImpl &#x3D; Java.use(&#39;mtopsdk.mtop.protocol.builder.impl.InnerProtocolParamBuilderImpl&#39;);

&#x2F;&#x2F; create MtopBusiness
let myMtopBusiness &#x3D; MtopBusiness.build(myMtopRequest);
myMtopBusiness.useWua();
myMtopBusiness.reqMethod(MethodEnum.POST.value);
myMtopBusiness.setCustomDomain(&quot;mtop.damai.cn&quot;);
myMtopBusiness.setBizId(24);
myMtopBusiness.setErrorNotifyAfterCache(true);
myMtopBusiness.reqStartTime &#x3D; System.currentTimeMillis();
myMtopBusiness.isCancelled &#x3D; false;
myMtopBusiness.isCached &#x3D; false;
myMtopBusiness.clazz &#x3D; null;
myMtopBusiness.requestType &#x3D; 0;
myMtopBusiness.requestContext &#x3D; null;
myMtopBusiness.mtopCommitStatData(false);
myMtopBusiness.sendStartTime &#x3D; System.currentTimeMillis();

let createListenerProxy &#x3D; myMtopBusiness.$super.createListenerProxy(myMtopBusiness.$super.listener.value);
let createMtopContext &#x3D; myMtopBusiness.createMtopContext(createListenerProxy);
let myMtopStatistics &#x3D; MtopStatistics.$new(null, null); &#x2F;&#x2F;创建一个空的统计类
createMtopContext.stats.value &#x3D; myMtopStatistics;
myMtopBusiness.$super.mtopContext.value &#x3D; createMtopContext;
createMtopContext.apiId.value &#x3D; ApiID.$new(null, createMtopContext);

let myMtopContext &#x3D; createMtopContext;
myMtopContext.mtopRequest.value &#x3D; myMtopRequest;
let myInnerProtocolParamBuilderImpl &#x3D; InnerProtocolParamBuilderImpl.$new();
let res &#x3D; myInnerProtocolParamBuilderImpl.buildParams(myMtopContext);
console.log(&#96;myInnerProtocolParamBuilderImpl.buildParams &#x3D;&gt; $&#123;HashMap2Str(res)&#125;&#96;)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>再次执行<code>frida -U -l .\reverse\new_request.js 大麦</code>，输出结果如下图，此时已能根据笔者任意构建的请求data输出其他加密参数：</p>
<p><img src="/./../../img/640-1695711110159-224.png" alt="图片"></p>
<p>对于order.create的原理类似，此处不再赘述。</p>
<p>![图片](data:image&#x2F;svg+xml,&lt;%3Fxml version&#x3D;’1.0’ encoding&#x3D;’UTF-8’%3F&gt;<svg width='1px' height='1px' viewBox='0 0 1 1' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'><title></title><g stroke='none' stroke-width='1' fill='none' fill-rule='evenodd' fill-opacity='0'><g transform='translate(-249.000000, -126.000000)' fill='%23FFFFFF'><rect x='249' y='126' width='1' height='1'></rect></g></g></svg>)</p>
<p>原文链接：<a target="_blank" rel="noopener" href="https://github.com/m2kar/m2kar.github.io/issues/21">https://github.com/m2kar/m2kar.github.io/issues/21</a></p>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/Android%E9%80%86%E5%90%91-%E6%9F%90%E9%BA%A6%E7%BD%91APK%E6%8A%A2%E7%A5%A8%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/Android%E9%80%86%E5%90%91-%E6%9F%90%E9%BA%A6%E7%BD%91APK%E6%8A%A2%E7%A5%A8%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/";
            const title         = "「Android逆向-某麦网APK抢票接口加密参数分析」";
            const excerpt       = `一、前言针对某麦网部分演唱会门票仅能在app渠道抢票的问题，本文研究了APK的抢票接口并编写了抢票工具。本文介绍的顺序为环境搭建、抓包、trace分析、接口参数获取、rpc调用实现，以及最终的功能实现。通过阅读本文，你将学到反抓包技术...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/APP%E9%80%86%E5%90%91/" rel="tag">APP逆向</a>, <a class="tag-none-link" href="/tags/android%E9%80%86%E5%90%91/" rel="tag">android逆向</a>, <a class="tag-none-link" href="/tags/%E5%A4%A7%E9%BA%A6%E7%BD%91%E6%8A%A2%E7%A5%A8/" rel="tag">大麦网抢票</a>, <a class="tag-none-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-10-07T08:01:00.716Z" itemprop="dateModified">最后编辑：2023-10-07</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 项目部署踩坑记录" href="/2023/09/11/excel中台系统/项目部署踩坑记录/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" 吾爱破解安卓逆向入门教程《安卓逆向这档事》番外实战篇1-某电影视全家桶" href="/2023/09/27/app逆向/安卓逆向这档事番外实战篇1-某电影视全家桶/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/about.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">分享学习的文章分享基地</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                78
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                9
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                41
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/chatgpt/">chatgpt</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/excel/">excel</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mariadb/">mariadb</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/tao%E7%B3%BB/">tao系</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vba-access/">vba-access</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E6%95%99%E7%A8%8B/">安卓逆向教程</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E9%80%86%E5%90%91/">爬虫逆向</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0/">项目日记</a><span class="category-list-count">3</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/APP%E9%80%86%E5%90%91/" style="font-size: 0.73em;">APP逆向</a> <a href="/tags/ChatGPT/" style="font-size: 0.63em;">ChatGPT</a> <a href="/tags/access/" style="font-size: 0.77em;">access</a> <a href="/tags/android%E9%80%86%E5%90%91/" style="font-size: 0.7em;">android逆向</a> <a href="/tags/chrom/" style="font-size: 0.6em;">chrom</a> <a href="/tags/dootask/" style="font-size: 0.6em;">dootask</a> <a href="/tags/excel/" style="font-size: 0.8em;">excel</a> <a href="/tags/excel-access-vba/" style="font-size: 0.6em;">excel - access - vba</a> <a href="/tags/github/" style="font-size: 0.63em;">github</a> <a href="/tags/hexo/" style="font-size: 0.6em;">hexo</a> <a href="/tags/ideas/" style="font-size: 0.63em;">ideas</a> <a href="/tags/mariadb/" style="font-size: 0.6em;">mariadb</a> <a href="/tags/markdown/" style="font-size: 0.6em;">markdown</a> <a href="/tags/pandas/" style="font-size: 0.6em;">pandas</a> <a href="/tags/vba/" style="font-size: 0.8em;">vba</a> <a href="/tags/vercel/" style="font-size: 0.6em;">vercel</a> <a href="/tags/vervel/" style="font-size: 0.6em;">vervel</a> <a href="/tags/%E5%88%97%E8%A1%A8%E6%A1%86/" style="font-size: 0.67em;">列表框</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2023/10/07/app%E9%80%86%E5%90%91/tao%E7%B3%BBx-mini-wua%E3%80%81x-sign%E3%80%81x-sgext%E3%80%81x-umt/"><i class="fa  fa-book"></i> tao系x-mini-wua、x-sign、x-sgext、x-umt</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/10/07/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91-%E6%9F%90%E9%BA%A6%E7%BD%91-x-mini-wua-x-sgext-x-sign-x-umt-x-utdid/"><i class="fa  fa-book"></i> 安卓逆向 - 某麦网 x-mini-wua x-sgext x-sign x-umt x-utdid</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/10/07/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91-Frida-Hook%EF%BC%88%E6%8A%93%E5%8C%85%E5%AE%9E%E8%B7%B5%EF%BC%89/"><i class="fa  fa-book"></i> 安卓逆向 - Frida Hook（抓包实践）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/10/07/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/"><i class="fa  fa-book"></i> 安卓逆向 - 基础入门教程</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/10/07/%E5%85%B3%E4%BA%8Edootask%E6%96%87%E4%BB%B6%E6%89%B9%E9%87%8F%E5%AF%BC%E5%87%BA/dootask%E6%96%87%E4%BB%B6%E6%89%B9%E9%87%8F%E5%AF%BC%E5%87%BA/"><i class="fa  fa-book"></i> dootask文件批量导出</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 栋栋的个人博客 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by John DD.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>




    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>