<!DOCTYPE html>
<html lang="zh-CN">
    <head>
  <!-- 元数据 -->
  <meta charset="utf-8">
  
  
  <title>吾爱破解安卓逆向入门教程《安卓逆向这档事》六、校验的N次方-签名校验对抗、PM理、IO重定向 | 栋栋的个人博客</title>
  
  <meta name="author" content="John DD" />
  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="robots" content="index,follow" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <meta name="format-detection" content="telphone=no, email=no" />
  
    <meta name="keywords" content="APP逆向, android逆向, 吾爱破解教程10节, 大麦网抢票, 逆向" />
  
  <meta name="description" content="一、课程目标 1.了解APK文件签名2.了解APK常见校验及校验对抗方法3.了解PM代理和IO重定向4.smali语法之赋值 二、工具 1.教程Demo(更新)2.MT管理器&#x2F;NP管理器3.雷电模拟器4.Jadx-gui(第三课课件里有)5.算法助手(第四课课件里有) 三、课程内容 1.什么是校验是开发者在数据传送时采用的一种校正数据的一种方式常见的校验有:签名校验(最常见)、dexc">
<meta property="og:type" content="article">
<meta property="og:title" content="吾爱破解安卓逆向入门教程《安卓逆向这档事》六、校验的N次方-签名校验对抗、PM理、IO重定向">
<meta property="og:url" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E8%BF%99%E6%A1%A3%E4%BA%8B(6)%E3%80%81%E6%A0%A1%E9%AA%8C%E7%9A%84N%E6%AC%A1%E6%96%B9-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%AF%B9%E6%8A%97%E3%80%81PM%E7%90%86%E3%80%81IO%E9%87%8D%E5%AE%9A%E5%90%91/index.html">
<meta property="og:site_name" content="栋栋的个人博客">
<meta property="og:description" content="一、课程目标 1.了解APK文件签名2.了解APK常见校验及校验对抗方法3.了解PM代理和IO重定向4.smali语法之赋值 二、工具 1.教程Demo(更新)2.MT管理器&#x2F;NP管理器3.雷电模拟器4.Jadx-gui(第三课课件里有)5.算法助手(第四课课件里有) 三、课程内容 1.什么是校验是开发者在数据传送时采用的一种校正数据的一种方式常见的校验有:签名校验(最常见)、dexc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504004-65.gif">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504005-66.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504005-67.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504005-68.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504005-69.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504006-70.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504006-71.png">
<meta property="og:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504006-72.png">
<meta property="article:published_time" content="2023-09-27T00:33:49.000Z">
<meta property="article:modified_time" content="2023-09-27T06:16:29.946Z">
<meta property="article:author" content="John DD">
<meta property="article:tag" content="逆向">
<meta property="article:tag" content="APP逆向">
<meta property="article:tag" content="android逆向">
<meta property="article:tag" content="大麦网抢票">
<meta property="article:tag" content="吾爱破解教程10节">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/img/640-1695707504004-65.gif">
  
  <!-- 站点验证相关 -->
  
    
    
    
  
  <!-- 样式表文件 -->
  <link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"></script>
  
    <link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme: dark)"></script>
    <script src="/js/kr-dark.min.js"></script>
  
  
    <link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"></script>
  
  <link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"></script>
  <link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"></script>
  
  
    <link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"></script>
  
  
    <link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"></script>
  
  <!-- 不得不预先加载的一些JS文件 -->
  <script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script>
  
    <script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script>
  
  
  <style>
    
      .kratos-cover.kratos-cover-2 {
        background-image: url('/images/banner.webp');
      }
    
    
  </style>
  
<meta name="generator" content="Hexo 6.3.0"></head>


    <body class="custom-background">
        <div id="kratos-wrapper">
    <div id="kratos-page">
        <div id="kratos-header">
            <header id="kratos-desktop-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="nav-header">
                        <nav id="kratos-menu-wrap">
                            <ul id="kratos-primary-menu" class="sf-menu">
                                
                                    
                                    
                                        
                                            <li><a href="/"><i class="fa fa-home"></i>首页</a></li>
                                        
                                    
                                        
                                            <li><a href="/archives/"><i class="fa fa-file"></i>档案馆</a></li>
                                        
                                    
                                        
                                            <li><a href="/friends/"><i class="fa fa-paw"></i>好伙伴</a></li>
                                        
                                    
                                        
                                            <li>
                                                <a><i class="fa fa-link"></i>链接</a>
                                                <ul class="sub-menu">
                                                    
                                                        
                                                    
                                                </ul>
                                            </li>
                                        
                                    
                                
                            </ul>
                        </nav>
                    </div>
                </div>
            </header>
            <header id="kratos-mobile-topnav" class="kratos-topnav">
                <div class="container">
                    <div class="color-logo"><a href="/">栋栋的个人博客</a></div>
                    <div class="nav-toggle">
                        <a class="kratos-nav-toggle js-kratos-nav-toggle">
                            <i></i>
                        </a>
                    </div>
                </div>
            </header>
        </div>
        <div class="kratos-start kratos-hero-2">
            <!-- <div class="kratos-overlay"></div> -->
            <div class="kratos-cover kratos-cover-2 text-center">
                <div class="desc desc2 animate-box">
                    <a href="/">
                        <h2>栋栋的个人博客</h2> <br />
                        <span></span>
                    </a>
                </div>
            </div>
        </div>

        <div id="kratos-blog-post">
            <div class="container">
                <div id="main" class="row">
                    

        

            <section class="col-md-8">

        

            <article itemscope itemtype="https://schema.org/Article">
    
    <link itemprop="mainEntityOfPage" href="https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E8%BF%99%E6%A1%A3%E4%BA%8B(6)%E3%80%81%E6%A0%A1%E9%AA%8C%E7%9A%84N%E6%AC%A1%E6%96%B9-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%AF%B9%E6%8A%97%E3%80%81PM%E7%90%86%E3%80%81IO%E9%87%8D%E5%AE%9A%E5%90%91/">
    <div class="kratos-hentry kratos-post-inner clearfix">
        <header class="kratos-entry-header">
            
                <h1 class="kratos-entry-title text-center" itemprop="name headline">吾爱破解安卓逆向入门教程《安卓逆向这档事》六、校验的N次方-签名校验对抗、PM理、IO重定向</h1>
            
            
            <ul class="kratos-post-meta text-center">
                <li><time datetime="2023-09-27T00:33:49.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2023-09-27</time></li>
                <li itemprop="author" itemscope itemtype="https://schema.org/Person">
                    <i class="fa fa-user"></i> 作者 <span itemprop="name">John DD</span>
                </li>
                
                    <li>
                        <i class="fa fa-edit"></i> 
                        
                        
                            ~22.38K
                        
                        字
                    </li>
                
                
            </ul>
        </header>
        <div class="kratos-post-content">
            
            <div id="expire-alert" class="alert alert-warning hidden" role="alert">
                <div class="icon"><i class="fa fa-warning"></i></div>
                <div class="text"><p>本文最后编辑于 <time datetime="1695795389946"></time> 前，其中的内容可能需要更新。</p></div>
            </div>
            
            
            
            <hr />
            <div itemprop="articleBody"><p><img src="/./../img/640-1695707504004-65.gif" alt="图片"></p>
<h1 id="一、课程目标"><a href="#一、课程目标" class="headerlink" title="一、课程目标"></a>一、课程目标</h1><hr>
<p>1.了解APK文件签名<br>2.了解APK常见校验及校验对抗方法<br>3.了解PM代理和IO重定向<br>4.smali语法之赋值</p>
<h1 id="二、工具"><a href="#二、工具" class="headerlink" title="二、工具"></a>二、工具</h1><hr>
<p>1.教程Demo(更新)<br>2.MT管理器&#x2F;NP管理器<br>3.雷电模拟器<br>4.Jadx-gui(第三课课件里有)<br>5.算法助手(第四课课件里有)</p>
<h1 id="三、课程内容"><a href="#三、课程内容" class="headerlink" title="三、课程内容"></a>三、课程内容</h1><hr>
<h2 id="1-什么是校验"><a href="#1-什么是校验" class="headerlink" title="1.什么是校验"></a>1.什么是校验</h2><p>是开发者在数据传送时采用的一种校正数据的一种方式<br>常见的校验有:签名校验(最常见)、dexcrc校验、apk完整性校验、路径文件校验等</p>
<h2 id="2-什么是APK签名"><a href="#2-什么是APK签名" class="headerlink" title="2.什么是APK签名"></a>2.什么是APK签名</h2><p>通过对 Apk 进行签名，开发者可以证明对 Apk 的所有权和控制权，可用于安装和更新其应用。而在 Android 设备上的安装 Apk ，如果是一个没有被签名的 Apk，则会被拒绝安装。在安装 Apk 的时候，软件包管理器也会验证 Apk 是否已经被正确签名，并且通过签名证书和数据摘要验证是否合法没有被篡改。只有确认安全无篡改的情况下，才允许安装在设备上。</p>
<p>简单来说，APK 的签名主要作用有两个：</p>
<ol>
<li>证明 APK 的所有者。</li>
<li>允许 Android 市场和设备校验 APK 的正确性。</li>
</ol>
<p>Android 目前支持以下四种应用签名方案：<br>v1 方案：基于 JAR 签名。<br>v2 方案：APK 签名方案 v2（在 Android 7.0 中引入）<br>v3 方案：APK 签名方案 v3（在 Android 9 中引入）<br>v4 方案：APK 签名方案 v4（在 Android 11 中引入）</p>
<p>V1 签名的机制主要就在 META-INF 目录下的三个文件，MANIFEST.MF，ANDROID.SF，ANDROID.RSA，他们都是 V1 签名的产物。<br>（1）MANIFEST.MF：这是摘要文件。程序遍历Apk包中的所有文件(entry)，对非文件夹非签名文件的文件，逐个用SHA1(安全哈希算法)生成摘要信息，再用Base64进行编码。如果你改变了apk包中的文件，那么在apk安装校验时，改变后的文件摘要信息与MANIFEST.MF的检验信息不同，于是程序就不能成功安装。<br><img src="/./../img/640-1695707504005-66.png" alt="图片"></p>
<p>（2）c.SF：这是对摘要的签名文件。对前一步生成的MANIFEST.MF，使用SHA1-RSA算法，用开发者的私钥进行签名。在安装时只能使用公钥才能解密它。解密之后，将它与未加密的摘要信息（即，MANIFEST.MF文件）进行对比，如果相符，则表明内容没有被异常修改。<br><img src="/./../img/640-1695707504005-67.png" alt="图片"><br>（3）ANDROID.RSA文件中保存了公钥、所采用的加密算法等信息。<br><img src="/./../img/640-1695707504005-68.png" alt="图片"><br>在某些情况下，直接对apk进行v1签名可以绕过apk的签名校验</p>
<p>v2方案会将 APK 文件视为 blob，并对整个文件进行签名检查。对 APK 进行的任何修改（包括对 ZIP 元数据进行的修改）都会使 APK 签名作废。这种形式的 APK 验证不仅速度要快得多，而且能够发现更多种未经授权的修改。</p>
<h2 id="3-什么是签名校验"><a href="#3-什么是签名校验" class="headerlink" title="3.什么是签名校验"></a>3.什么是签名校验</h2><p>如何判断是否有签名校验？<br>不做任何修改，直接签名安装，应用闪退则说明大概率有签名校验</p>
<p>一般来说，普通的签名校验会导致软件的闪退，黑屏，卡启动页等<br>当然，以上都算是比较好的，有一些比较狠的作者，则会直接rm -rf &#x2F;，把基带都格掉的一键变砖。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kill/killProcess-----kill/KillProcess<span class="token punctuation">(</span><span class="token punctuation">)</span>可以杀死当前应用活动的进程，这一操作将会把所有该进程内的资源（包括线程全部清理掉）.当然，由于ActivityManager时刻监听着进程，一旦发现进程被非正常Kill，它将会试图去重启这个进程。这就是为什么，有时候当我们试图这样去结束掉应用时，发现它又自动重新启动的原因.

system.exit-----杀死了整个进程，这时候活动所占的资源也会被释放。

finish----------仅仅针对Activity，当调用finish<span class="token punctuation">(</span><span class="token punctuation">)</span>时，只是将活动推向后台，并没有立即释放内存，活动的资源并没有被清理<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在我个人见过最恶心的签名校验中，当属三角校验(低调大佬教的)最烦人。<br>所谓三角校验，就是so检测dex，动态加载的dex(在软件运行时会解压释放一段dex文件，检测完后就删除)检测so，dex检测动态加载的dex</p>
<p><img src="/./../img/640-1695707504005-69.png" alt="图片"></p>
<p>普通获取签名校验代码：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token class-name">SignCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> trueSignMD5 <span class="token operator">=</span> <span class="token string">"d0add9987c7c84aeb7198c3ff26ca152"</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> nowSignMD5 <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 得到签名的MD5</span>
        <span class="token class-name">PackageInfo</span> packageInfo <span class="token operator">=</span> <span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPackageInfo</span><span class="token punctuation">(</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">PackageManager</span><span class="token punctuation">.</span><span class="token constant">GET_SIGNATURES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Signature</span><span class="token punctuation">[</span><span class="token punctuation">]</span> signs <span class="token operator">=</span> packageInfo<span class="token punctuation">.</span>signatures<span class="token punctuation">;</span>
        <span class="token class-name">String</span> signBase64 <span class="token operator">=</span> <span class="token class-name">Base64Util</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>signs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nowSignMD5 <span class="token operator">=</span> <span class="token class-name">MD5Utils</span><span class="token punctuation">.</span><span class="token function">MD5</span><span class="token punctuation">(</span>signBase64<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">PackageManager<span class="token punctuation">.</span>NameNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> trueSignMD5<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>nowSignMD5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>系统将应用的签名信息封装在 PackageInfo 中，调用 PackageManager 的 getPackageInfo(String packageName, int flags) 即可获取指定包名的签名信息</p>
<h2 id="4-签名校验对抗"><a href="#4-签名校验对抗" class="headerlink" title="4.签名校验对抗"></a>4.签名校验对抗</h2><p>方法一:核心破解插件，不签名安装应用<br>方法二:一键过签名工具，例如MT、NP、ARMPro、CNFIX、Modex的去除签名校验功能<br>方法三:具体分析签名校验逻辑(手撕签名校验)<br>方法四:io重定向–VA&amp;SVC：ptrace+seccomp<br>SVC的TraceHook沙箱的实现&amp;无痕Hook实现思路<br>方法五:去作者家严刑拷打拿到.jks文件和密码</p>
<h2 id="5-手动实现PM代理"><a href="#5-手动实现PM代理" class="headerlink" title="5.手动实现PM代理"></a>5.手动实现PM代理</h2><h3 id="1-什么是PMS"><a href="#1-什么是PMS" class="headerlink" title="1.什么是PMS"></a>1.什么是PMS</h3><p>思路源自：Android中Hook 应用签名方法</p>
<p>PackageManagerService（简称PMS），是Android系统核心服务之一，处理包管理相关的工作，常见的比如安装、卸载应用等。</p>
<h3 id="2-实现方法以及原理解析"><a href="#2-实现方法以及原理解析" class="headerlink" title="2.实现方法以及原理解析"></a>2.实现方法以及原理解析</h3><p>HOOK PMS代码:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"> 复制代码 隐藏代码
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>zj<span class="token punctuation">.</span>hookpms</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span></span><span class="token class-name">Context</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>pm<span class="token punctuation">.</span></span><span class="token class-name">PackageManager</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">android<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceManagerWraper</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">ZJ</span> <span class="token operator">=</span> <span class="token string">"ZJ595"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookPMS</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">String</span> signed<span class="token punctuation">,</span> <span class="token class-name">String</span> appPkgName<span class="token punctuation">,</span> <span class="token keyword">int</span> hashCode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 获取全局的ActivityThread对象</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> activityThreadClass <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.app.ActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Method</span> currentActivityThreadMethod <span class="token operator">=</span>
                    activityThreadClass<span class="token punctuation">.</span><span class="token function">getDeclaredMethod</span><span class="token punctuation">(</span><span class="token string">"currentActivityThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> currentActivityThread <span class="token operator">=</span> currentActivityThreadMethod<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 获取ActivityThread里面原始的sPackageManager</span>
            <span class="token class-name">Field</span> sPackageManagerField <span class="token operator">=</span> activityThreadClass<span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"sPackageManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sPackageManagerField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> sPackageManager <span class="token operator">=</span> sPackageManagerField<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentActivityThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 准备好代理对象, 用来替换原始的对象</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> iPackageManagerInterface <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"android.content.pm.IPackageManager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Object</span> proxy <span class="token operator">=</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
                    iPackageManagerInterface<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>iPackageManagerInterface<span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
                    <span class="token keyword">new</span> <span class="token class-name">PmsHookBinderInvocationHandler</span><span class="token punctuation">(</span>sPackageManager<span class="token punctuation">,</span> signed<span class="token punctuation">,</span> appPkgName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 1. 替换掉ActivityThread里面的 sPackageManager 字段</span>
            sPackageManagerField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>currentActivityThread<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2. 替换 ApplicationPackageManager里面的 mPM对象</span>
            <span class="token class-name">PackageManager</span> pm <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Field</span> mPmField <span class="token operator">=</span> pm<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"mPM"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPmField<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPmField<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>pm<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">ZJ</span><span class="token punctuation">,</span> <span class="token string">"hook pms error:"</span> <span class="token operator">+</span> <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">getStackTraceString</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hookPMS</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> <span class="token class-name">Sign</span> <span class="token operator">=</span> <span class="token string">"原包的签名信息"</span><span class="token punctuation">;</span>
        <span class="token function">hookPMS</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token class-name">Sign</span><span class="token punctuation">,</span> <span class="token string">"com.zj.hookpms"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ActivityThread的静态变量sPackageManager<br>ApplicationPackageManager对象里面的mPM变量</p>
<h2 id="6-IO重定向"><a href="#6-IO重定向" class="headerlink" title="6.IO重定向"></a>6.IO重定向</h2><p>什么是IO重定向？</p>
<p>例：在读A文件的时候指向B文件</p>
<p>平头哥的核心代码<br>Virtual Engine for Android(Support 12.0 in business version)</p>
<p>IO重定向可以干嘛？</p>
<p>1，可以让文件只读，不可写</p>
<p>2，禁止访问文件</p>
<p>3，路径替换</p>
<p>具体实现：<br>过签名检测(读取原包)<br>风控对抗(例:一个文件记录App启动的次数)<br>过Root检测，Xposed检测(文件不可取)</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">using namespace std<span class="token punctuation">;</span>  
string packname<span class="token punctuation">;</span>  
string origpath<span class="token punctuation">;</span>  
string fakepath<span class="token punctuation">;</span>  

<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig_openat<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token constant">FILE</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>orig_fopen<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig_syscall<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">long</span> number<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig__NR_openat<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig_dlopen_CI<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig_dlopen_CIV<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">int</span> flag<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>extinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>orig_dlopen_CIVV<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>extinfo<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>caller_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token keyword">static</span> inline bool <span class="token function">needs_mode</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token constant">O_CREAT</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">O_CREAT</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token constant">O_TMPFILE</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">O_TMPFILE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
bool <span class="token function">startsWith</span><span class="token punctuation">(</span>string str<span class="token punctuation">,</span> string sub<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  

bool <span class="token function">endsWith</span><span class="token punctuation">(</span>string s<span class="token punctuation">,</span>string sub<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
    <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">rfind</span><span class="token punctuation">(</span>sub<span class="token punctuation">)</span><span class="token operator">==</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>sub<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
bool <span class="token function">isOrigAPK</span><span class="token punctuation">(</span>string  path<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  

    <span class="token keyword">if</span><span class="token punctuation">(</span>path<span class="token operator">==</span>origpath<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
<span class="token comment">//该函数的功能是在打开一个文件时进行拦截，并在满足特定条件时将文件路径替换为另一个路径  </span>

<span class="token comment">//fake_open 函数有三个参数：  </span>
<span class="token comment">//pathname：一个字符串，表示要打开的文件的路径。  </span>
<span class="token comment">//flags：一个整数，表示打开文件的方式，例如只读、只写、读写等。  </span>
<span class="token comment">//mode（可选参数）：一个整数，表示打开文件时应用的权限模式。  </span>
<span class="token keyword">int</span> <span class="token function">fake_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    mode_t mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needs_mode</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        va_list args<span class="token punctuation">;</span>  
        <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        mode <span class="token operator">=</span> static_cast<span class="token generics"><span class="token punctuation">&lt;</span>mode_t<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token function">va_arg</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token comment">//LOGI("open,  path: %s, flags: %d, mode: %d",pathname, flags ,mode);  </span>
    string cpp_path<span class="token operator">=</span> pathname<span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isOrigAPK</span><span class="token punctuation">(</span>cpp_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"libc_open, redirect: %s, --->: %s"</span><span class="token punctuation">,</span>pathname<span class="token punctuation">,</span> fakepath<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> <span class="token function">orig_open</span><span class="token punctuation">(</span><span class="token string">"/data/user/0/com.zj.wuaipojie/files/base.apk"</span><span class="token punctuation">,</span> flags<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token keyword">return</span>  <span class="token function">orig_open</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token comment">//该函数的功能是在打开一个文件时进行拦截，并在满足特定条件时将文件路径替换为另一个路径  </span>

<span class="token comment">//fake_openat 函数有四个参数：  </span>
<span class="token comment">//fd：一个整数，表示要打开的文件的文件描述符。  </span>
<span class="token comment">//pathname：一个字符串，表示要打开的文件的路径。  </span>
<span class="token comment">//flags：一个整数，表示打开文件的方式，例如只读、只写、读写等。  </span>
<span class="token comment">//mode（可选参数）：一个整数，表示打开文件时应用的权限模式。  </span>
<span class="token comment">//openat 函数的作用类似于 open 函数，但是它使用文件描述符来指定文件路径，而不是使用文件路径本身。这样，就可以在打开文件时使用相对路径，而不必提供完整的文件路径。  </span>
<span class="token comment">//例如，如果要打开相对于当前目录的文件，可以使用 openat 函数，而不是 open 函数，因为 open 函数只能使用绝对路径。  </span>
<span class="token comment">//  </span>
<span class="token keyword">int</span> <span class="token function">fake_openat</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    mode_t mode <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">needs_mode</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        va_list args<span class="token punctuation">;</span>  
        <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        mode <span class="token operator">=</span> static_cast<span class="token generics"><span class="token punctuation">&lt;</span>mode_t<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token function">va_arg</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"openat, fd: %d, path: %s, flags: %d, mode: %d"</span><span class="token punctuation">,</span>fd <span class="token punctuation">,</span>pathname<span class="token punctuation">,</span> flags <span class="token punctuation">,</span>mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    string cpp_path<span class="token operator">=</span> pathname<span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isOrigAPK</span><span class="token punctuation">(</span>cpp_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"libc_openat, redirect: %s, --->: %s"</span><span class="token punctuation">,</span>pathname<span class="token punctuation">,</span> fakepath<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span>  <span class="token function">orig_openat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>fakepath<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> flags<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token keyword">return</span> <span class="token function">orig_openat</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>pathname<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  
<span class="token constant">FILE</span> <span class="token operator">*</span><span class="token function">fake_fopen</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>mode<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  

    string cpp_path<span class="token operator">=</span> filename<span class="token punctuation">;</span>  
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isOrigAPK</span><span class="token punctuation">(</span>cpp_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">return</span>  <span class="token function">orig_fopen</span><span class="token punctuation">(</span>fakepath<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token keyword">return</span> <span class="token function">orig_fopen</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>  
<span class="token comment">//该函数的功能是在执行系统调用时进行拦截，并在满足特定条件时修改系统调用的参数。  </span>
<span class="token comment">//syscall 函数是一个系统调用，是程序访问内核功能的方法之一。使用 syscall 函数可以调用大量的系统调用，它们用于实现操作系统的各种功能，例如打开文件、创建进程、分配内存等。  </span>
<span class="token comment">//  </span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">fake_syscall</span><span class="token punctuation">(</span><span class="token keyword">long</span> number<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  
    va_list list<span class="token punctuation">;</span>  

    <span class="token function">va_start</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        arg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">va_arg</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token function">va_end</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">==</span> __NR_openat<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>cpp_path <span class="token operator">=</span> static_cast<span class="token operator">&lt;</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"syscall __NR_openat, fd: %d, path: %s, flags: %d, mode: %d"</span><span class="token punctuation">,</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">,</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isOrigAPK</span><span class="token punctuation">(</span>cpp_path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
            <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"syscall __NR_openat, redirect: %s, --->: %s"</span><span class="token punctuation">,</span>arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fakepath<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
            <span class="token keyword">return</span> <span class="token function">orig_syscall</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span>arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fakepath<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>arg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>arg<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">&#125;</span>  
    <span class="token punctuation">&#125;</span>  
    <span class="token keyword">return</span> <span class="token function">orig_syscall</span><span class="token punctuation">(</span>number<span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> arg<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

<span class="token punctuation">&#125;</span>  

<span class="token comment">//函数的功能是获取当前应用的包名、APK 文件路径以及库文件路径，并将这些信息保存在全局变量中  </span>
<span class="token comment">//函数调用 GetObjectClass 和 GetMethodID 函数来获取 context 对象的类型以及 getPackageName 方法的 ID。然后，函数调用 CallObjectMethod 函数来调用 getPackageName 方法，获取当前应用的包名。最后，函数使用 GetStringUTFChars 函数将包名转换为 C 字符串，并将包名保存在 packname 全局变量中  </span>
<span class="token comment">//接着，函数使用 fakepath 全局变量保存了 /data/user/0/&lt;packname>/files/base.apk 这样的路径，其中 &lt;packname> 是当前应用的包名。  </span>
<span class="token comment">//然后，函数再次调用 GetObjectClass 和 GetMethodID 函数来获取 context 对象的类型以及 getApplicationInfo 方法的 ID。然后，函数调用 CallObjectMethod 函数来调用 getApplicationInfo 方法，获取当前应用的 ApplicationInfo 对象。  </span>
<span class="token comment">//它先调用 GetObjectClass 函数获取 ApplicationInfo 对象的类型，然后调用 GetFieldID 函数获取 sourceDir 字段的 ID。接着，函数使用 GetObjectField 函数获取 sourceDir 字段的值，并使用 GetStringUTFChars 函数将其转换为 C 字符串。最后，函数将 C 字符串保存在 origpath 全局变量中，表示当前应用的 APK 文件路径。  </span>
<span class="token comment">//最后，函数使用 GetFieldID 和 GetObjectField 函数获取 nativeLibraryDir 字段的值，并使用 GetStringUTFChars 函数将其转换为 C 字符串。函数最后调用 LOGI 函数打印库文件路径，但是并没有将其保存在全局变量中。  </span>

extern <span class="token string">"C"</span> <span class="token constant">JNIEXPORT</span> <span class="token keyword">void</span> <span class="token constant">JNICALL</span>  
<span class="token class-name">Java_com_zj_wuaipojie_util_SecurityUtil_hook</span><span class="token punctuation">(</span><span class="token class-name">JNIEnv</span> <span class="token operator">*</span>env<span class="token punctuation">,</span> jclass clazz<span class="token punctuation">,</span> jobject context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    jclass conext_class <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    jmethodID methodId_pack <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>conext_class<span class="token punctuation">,</span> <span class="token string">"getPackageName"</span><span class="token punctuation">,</span>  
                                               <span class="token string">"()Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto packname_js <span class="token operator">=</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span>jstring<span class="token punctuation">></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token class-name">CallObjectMethod</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> methodId_pack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pn <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetStringUTFChars</span><span class="token punctuation">(</span>packname_js<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    packname <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>pn<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    env<span class="token operator">-></span><span class="token class-name">ReleaseStringUTFChars</span><span class="token punctuation">(</span>packname_js<span class="token punctuation">,</span> pn<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//LOGI("packname: %s", packname.data());  </span>
    fakepath<span class="token operator">=</span> <span class="token string">"/data/user/0/"</span><span class="token operator">+</span> packname <span class="token operator">+</span><span class="token string">"/files/base.apk"</span><span class="token punctuation">;</span>  

    jclass conext_class2 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    jmethodID methodId_pack2 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetMethodID</span><span class="token punctuation">(</span>conext_class2<span class="token punctuation">,</span><span class="token string">"getApplicationInfo"</span><span class="token punctuation">,</span><span class="token string">"()Landroid/content/pm/ApplicationInfo;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    jobject application_info <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">CallObjectMethod</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span>methodId_pack2<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    jclass pm_clazz <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetObjectClass</span><span class="token punctuation">(</span>application_info<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    jfieldID package_info_id <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetFieldID</span><span class="token punctuation">(</span>pm_clazz<span class="token punctuation">,</span><span class="token string">"sourceDir"</span><span class="token punctuation">,</span><span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto sourceDir_js <span class="token operator">=</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span>jstring<span class="token punctuation">></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token class-name">GetObjectField</span><span class="token punctuation">(</span>application_info<span class="token punctuation">,</span>package_info_id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>sourceDir <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetStringUTFChars</span><span class="token punctuation">(</span>sourceDir_js<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    origpath <span class="token operator">=</span> <span class="token function">string</span><span class="token punctuation">(</span>sourceDir<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"sourceDir: %s"</span><span class="token punctuation">,</span> sourceDir<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    jfieldID package_info_id2 <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetFieldID</span><span class="token punctuation">(</span>pm_clazz<span class="token punctuation">,</span><span class="token string">"nativeLibraryDir"</span><span class="token punctuation">,</span><span class="token string">"Ljava/lang/String;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto nativeLibraryDir_js <span class="token operator">=</span> reinterpret_cast<span class="token generics"><span class="token punctuation">&lt;</span>jstring<span class="token punctuation">></span></span><span class="token punctuation">(</span>env<span class="token operator">-></span><span class="token class-name">GetObjectField</span><span class="token punctuation">(</span>application_info<span class="token punctuation">,</span>package_info_id2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nativeLibraryDir <span class="token operator">=</span> env<span class="token operator">-></span><span class="token class-name">GetStringUTFChars</span><span class="token punctuation">(</span>nativeLibraryDir_js<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">LOGI</span><span class="token punctuation">(</span><span class="token string">"nativeLibraryDir: %s"</span><span class="token punctuation">,</span> nativeLibraryDir<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">//LOGI("%s", "Start Hook");  </span>

    <span class="token comment">//启动hook  </span>
    <span class="token keyword">void</span> <span class="token operator">*</span>handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"libc.so"</span><span class="token punctuation">,</span><span class="token constant">RTLD_NOW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto pagesize <span class="token operator">=</span> <span class="token function">sysconf</span><span class="token punctuation">(</span>_SC_PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"open"</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">-</span>pagesize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto addr2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"openat"</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">-</span>pagesize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto addr3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>fopen<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">-</span>pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    auto addr4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>uintptr_t<span class="token punctuation">)</span>syscall<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">-</span>pagesize<span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token comment">//解除部分机型open被保护  </span>
    <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>addr<span class="token punctuation">,</span> pagesize<span class="token punctuation">,</span> <span class="token constant">PROT_READ</span> <span class="token operator">|</span> <span class="token constant">PROT_WRITE</span> <span class="token operator">|</span> <span class="token constant">PROT_EXEC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>addr2<span class="token punctuation">,</span> pagesize<span class="token punctuation">,</span> <span class="token constant">PROT_READ</span> <span class="token operator">|</span> <span class="token constant">PROT_WRITE</span> <span class="token operator">|</span> <span class="token constant">PROT_EXEC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>addr3<span class="token punctuation">,</span> pagesize<span class="token punctuation">,</span> <span class="token constant">PROT_READ</span> <span class="token operator">|</span> <span class="token constant">PROT_WRITE</span> <span class="token operator">|</span> <span class="token constant">PROT_EXEC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">mprotect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>addr4<span class="token punctuation">,</span> pagesize<span class="token punctuation">,</span> <span class="token constant">PROT_READ</span> <span class="token operator">|</span> <span class="token constant">PROT_WRITE</span> <span class="token operator">|</span> <span class="token constant">PROT_EXEC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token class-name">DobbyHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fake_open<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>orig_open<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">DobbyHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"openat"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fake_openat<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>orig_openat<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">DobbyHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fopen<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fake_fopen<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>orig_fopen<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token class-name">DobbyHook</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>syscall<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>fake_syscall<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>orig_syscall<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
 复制代码 隐藏代码
        sget<span class="token operator">-</span>object p10<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">ContextUtils</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token constant">INSTANCE</span><span class="token operator">:</span><span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">ContextUtils</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p10<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">ContextUtils</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">Landroid</span><span class="token operator">/</span>content<span class="token operator">/</span><span class="token class-name">Context</span><span class="token punctuation">;</span>  

    move<span class="token operator">-</span>result<span class="token operator">-</span>object p10  

    invoke<span class="token operator">-</span><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>p10<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">SecurityUtil</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">hook</span><span class="token punctuation">(</span><span class="token class-name">Landroid</span><span class="token operator">/</span>content<span class="token operator">/</span><span class="token class-name">Context</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="7-其他常见校验"><a href="#7-其他常见校验" class="headerlink" title="7.其他常见校验"></a>7.其他常见校验</h2><h3 id="root检测："><a href="#root检测：" class="headerlink" title="root检测："></a>root检测：</h3><p>反制手段<br>1.算法助手、对话框取消等插件一键hook<br>2.分析具体的检测代码<br>3.利用IO重定向使文件不可读<br>4.修改Andoird源码，去除常见指纹</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fun <span class="token function">isDeviceRooted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">checkRootMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">checkRootMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">checkRootMethod3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

fun <span class="token function">checkRootMethod1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">&#123;</span>
    val buildTags <span class="token operator">=</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build<span class="token punctuation">.</span><span class="token constant">TAGS</span>
    <span class="token keyword">return</span> buildTags <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> buildTags<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"test-keys"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>

fun <span class="token function">checkRootMethod2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">&#123;</span>
    val paths <span class="token operator">=</span> <span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">"/system/app/Superuser.apk"</span><span class="token punctuation">,</span> <span class="token string">"/sbin/su"</span><span class="token punctuation">,</span> <span class="token string">"/system/bin/su"</span><span class="token punctuation">,</span> <span class="token string">"/system/xbin/su"</span><span class="token punctuation">,</span> <span class="token string">"/data/local/xbin/su"</span><span class="token punctuation">,</span> <span class="token string">"/data/local/bin/su"</span><span class="token punctuation">,</span> <span class="token string">"/system/sd/xbin/su"</span><span class="token punctuation">,</span>
            <span class="token string">"/system/bin/failsafe/su"</span><span class="token punctuation">,</span> <span class="token string">"/data/local/su"</span><span class="token punctuation">,</span> <span class="token string">"/su/bin/su"</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>path <span class="token keyword">in</span> paths<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">&#125;</span>

fun <span class="token function">checkRootMethod3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> <span class="token literal-property property">process</span><span class="token operator">:</span> Process<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">return</span> <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        process <span class="token operator">=</span> Runtime<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token function">arrayOf</span><span class="token punctuation">(</span><span class="token string">"/system/xbin/which"</span><span class="token punctuation">,</span> <span class="token string">"su"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        val bufferedReader <span class="token operator">=</span> <span class="token function">BufferedReader</span><span class="token punctuation">(</span><span class="token function">InputStreamReader</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
        bufferedReader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>t<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token boolean">false</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
        process<span class="token operator">?.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>定义了一个 <code>isDeviceRooted()</code> 函数，该函数调用了三个检测 root 的方法：<code>checkRootMethod1()</code>、<code>checkRootMethod2()</code> 和 <code>checkRootMethod3()</code>。</p>
<p><code>checkRootMethod1()</code> 方法检查设备的 <code>build tags</code> 是否包含 <code>test-keys</code>。这通常是用于测试的设备，因此如果检测到这个标记，则可以认为设备已被 root。</p>
<p><code>checkRootMethod2()</code> 方法检查设备是否存在一些特定的文件，这些文件通常被用于执行 root 操作。如果检测到这些文件，则可以认为设备已被 root。</p>
<p><code>checkRootMethod3()</code> 方法使用 <code>Runtime.exec()</code> 方法来执行 <code>which su</code> 命令，然后检查命令的输出是否不为空。如果输出不为空，则可以认为设备已被 root。</p>
<h3 id="模拟器检测"><a href="#模拟器检测" class="headerlink" title="模拟器检测"></a>模拟器检测</h3><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"> 复制代码 隐藏代码
fun <span class="token function">isEmulator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">&#123;</span> 
        <span class="token keyword">return</span> Build<span class="token punctuation">.</span><span class="token constant">FINGERPRINT</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"generic"</span><span class="token punctuation">)</span> <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">FINGERPRINT</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"unknown"</span><span class="token punctuation">)</span> <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">MODEL</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"google_sdk"</span><span class="token punctuation">)</span> Build<span class="token punctuation">.</span><span class="token constant">MODEL</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Emulator"</span><span class="token punctuation">)</span> <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">MODEL</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Android SDK built for x86"</span><span class="token punctuation">)</span> <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">MANUFACTURER</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">"Genymotion"</span><span class="token punctuation">)</span> <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">HOST</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"Build"</span><span class="token punctuation">)</span> <span class="token operator">||</span> Build<span class="token punctuation">.</span><span class="token constant">PRODUCT</span> <span class="token operator">==</span> <span class="token string">"google_sdk"</span> 
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过检测系统的 <code>Build</code> 对象来判断当前设备是否为模拟器。具体方法是检测 <code>Build.FINGERPRINT</code> 属性是否包含字符串 <code>&quot;generic&quot;</code>。</p>
<p>模拟器检测对抗</p>
<h3 id="反调试检测"><a href="#反调试检测" class="headerlink" title="反调试检测"></a>反调试检测</h3><p>安卓系统自带调试检测函数</p>
<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">fun <span class="token function">checkForDebugger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Debug<span class="token punctuation">.</span><span class="token function">isDebuggerConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token comment">// 如果调试器已连接，则终止应用程序  </span>
        System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  
    <span class="token punctuation">&#125;</span>  
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>debuggable属性</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">getAppCanDebug</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span><span class="token comment">//上下文对象为xxActivity.this</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">boolean</span> isDebug <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getApplicationInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> <span class="token class-name">ApplicationInfo</span><span class="token punctuation">.</span><span class="token constant">FLAG_DEBUGGABLE</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> isDebug<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ptrace检测</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> <span class="token function">ptrace_protect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//ptrace附加自身线程 会导致此进程TracerPid 变为父进程的TracerPid 即zygote</span>
<span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token function">ptrace</span><span class="token punctuation">(</span><span class="token constant">PTRACE_TRACEME</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment">//返回-1即为已经被调试</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>每个进程同时刻只能被1个调试进程ptrace ，主动ptrace本进程可以使得其他调试器无法调试</p>
<p>调试进程名检测</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">SearchObjProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    FILE<span class="token operator">*</span> pfile<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">0x1000</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

    pfile<span class="token operator">=</span><span class="token function">popen</span><span class="token punctuation">(</span><span class="token string">"ps"</span><span class="token punctuation">,</span><span class="token string">"r"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span>pfile<span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
        <span class="token comment">//LOGA("SearchObjProcess popen打开命令失败!\n");</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 获取结果</span>
    <span class="token comment">//LOGA("popen方案:\n");</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">fgets</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>pfile<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>

        <span class="token keyword">char</span><span class="token operator">*</span> strA<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> strB<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> strC<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token operator">*</span> strD<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
        strA<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"android_server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过查找匹配子串判断</span>
        strB<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"gdbserver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        strC<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"gdb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        strD<span class="token operator">=</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"fuwu"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>strA <span class="token operator">||</span> strB <span class="token operator">||</span>strC <span class="token operator">||</span> strD<span class="token punctuation">)</span>
        <span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token comment">// 执行到这里，判定为调试状态</span>

        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">pclose</span><span class="token punctuation">(</span>pfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>[原创]对安卓反调试和校验检测的一些实践与结论</p>
<h3 id="frida检测"><a href="#frida检测" class="headerlink" title="frida检测"></a>frida检测</h3><p>一些Frida检测手段</p>
<h2 id="8-smali语法小课堂之赋值"><a href="#8-smali语法小课堂之赋值" class="headerlink" title="8.smali语法小课堂之赋值"></a>8.smali语法小课堂之赋值</h2><h3 id="1-Int型赋值"><a href="#1-Int型赋值" class="headerlink" title="1.Int型赋值"></a>1.Int型赋值</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span>method <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> onCreate$lambda<span class="token operator">-</span><span class="token function">0</span><span class="token punctuation">(</span><span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>ui<span class="token operator">/</span><span class="token class-name">SmaliLearn</span><span class="token punctuation">;</span><span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token class-name">Landroid</span><span class="token operator">/</span>view<span class="token operator">/</span><span class="token class-name">View</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  
    <span class="token punctuation">.</span>registers <span class="token number">9</span>  

    <span class="token punctuation">.</span>line <span class="token number">21</span>  
    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>ui<span class="token operator">/</span><span class="token class-name">SmaliLearn</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">isVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">I</span>  

    move<span class="token operator">-</span>result p4  
        <span class="token comment">//判断vip的值分别对应不用的会员的等级</span>
    <span class="token keyword">if</span><span class="token operator">-</span>eqz p4<span class="token punctuation">,</span> <span class="token operator">:</span>cond_35  

    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> v0<span class="token punctuation">,</span> <span class="token number">0x1</span>  

    <span class="token keyword">if</span><span class="token operator">-</span>eq p4<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_2d  

    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">4</span> v0<span class="token punctuation">,</span> <span class="token number">0x4</span>  

    <span class="token keyword">if</span><span class="token operator">-</span>eq p4<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_25  

    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">16</span> v0<span class="token punctuation">,</span> <span class="token number">0x10</span>  

    <span class="token keyword">if</span><span class="token operator">-</span>eq p4<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_1d  

    <span class="token keyword">const</span><span class="token operator">/</span><span class="token number">16</span> v0<span class="token punctuation">,</span> <span class="token number">0x63</span>  

    <span class="token keyword">if</span><span class="token operator">-</span>eq p4<span class="token punctuation">,</span> v0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_15  

    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_3c  

    <span class="token operator">:</span>cond_15  
    <span class="token keyword">const</span><span class="token operator">-</span>string p4<span class="token punctuation">,</span> <span class="token string">"至尊会员"</span>  

    <span class="token punctuation">.</span>line <span class="token number">26</span>  
    check<span class="token operator">-</span>cast p4<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_3c  

    <span class="token operator">:</span>cond_1d  
    <span class="token keyword">const</span><span class="token operator">-</span>string p4<span class="token punctuation">,</span> <span class="token string">"超级会员"</span>  

    <span class="token punctuation">.</span>line <span class="token number">25</span>  
    check<span class="token operator">-</span>cast p4<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_3c  

    <span class="token operator">:</span>cond_25  
    <span class="token keyword">const</span><span class="token operator">-</span>string p4<span class="token punctuation">,</span> <span class="token string">"大会员"</span>  

    <span class="token punctuation">.</span>line <span class="token number">24</span>  
    check<span class="token operator">-</span>cast p4<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_3c  

    <span class="token operator">:</span>cond_2d  
    <span class="token keyword">const</span><span class="token operator">-</span>string p4<span class="token punctuation">,</span> <span class="token string">"会员"</span>  

    <span class="token punctuation">.</span>line <span class="token number">23</span>  
    check<span class="token operator">-</span>cast p4<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_3c  

    <span class="token operator">:</span>cond_35  
    <span class="token keyword">const</span><span class="token operator">-</span>string p4<span class="token punctuation">,</span> <span class="token string">"非会员"</span>  

    <span class="token punctuation">.</span>line <span class="token number">22</span>  
    check<span class="token operator">-</span>cast p4<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>

        <span class="token punctuation">.</span>line <span class="token number">28</span>  
        <span class="token comment">//判断vipEndTime的时间戳是否小于系统时间</span>
    <span class="token operator">:</span>goto_3c  
    <span class="token keyword">new</span><span class="token operator">-</span>instance p1<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">Date</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>direct <span class="token punctuation">&#123;</span>p1<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">Date</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>util<span class="token operator">/</span><span class="token class-name">Date</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">J</span>  

    move<span class="token operator">-</span>result<span class="token operator">-</span>wide v0  

    <span class="token punctuation">.</span>line <span class="token number">29</span>  
    <span class="token keyword">new</span><span class="token operator">-</span>instance p1<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>text<span class="token operator">/</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span>  

    <span class="token keyword">const</span><span class="token operator">-</span>string p4<span class="token punctuation">,</span> <span class="token string">"yyyy-MM-dd"</span>  

    invoke<span class="token operator">-</span>direct <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>text<span class="token operator">/</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token punctuation">.</span>line <span class="token number">30</span>  
    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>ui<span class="token operator">/</span><span class="token class-name">SmaliLearn</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">vipEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">J</span>  

    move<span class="token operator">-</span>result<span class="token operator">-</span>wide v2  

    cmp<span class="token operator">-</span><span class="token keyword">long</span> p4<span class="token punctuation">,</span> v2<span class="token punctuation">,</span> v0  

    <span class="token keyword">if</span><span class="token operator">-</span>gez p4<span class="token punctuation">,</span> <span class="token operator">:</span>cond_5c  

    <span class="token keyword">const</span><span class="token operator">-</span>string p1<span class="token punctuation">,</span> <span class="token string">"已过期"</span>  

    <span class="token punctuation">.</span>line <span class="token number">31</span>  
    check<span class="token operator">-</span>cast p1<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p2<span class="token punctuation">,</span> p1<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token keyword">goto</span> <span class="token operator">:</span>goto_6d  

    <span class="token punctuation">.</span>line <span class="token number">33</span>  
    <span class="token operator">:</span>cond_5c  
    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>ui<span class="token operator">/</span><span class="token class-name">SmaliLearn</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">vipEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">J</span>  

    move<span class="token operator">-</span>result<span class="token operator">-</span>wide v0  

    invoke<span class="token operator">-</span><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>v0<span class="token punctuation">,</span> v1<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Long</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">J</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Long</span><span class="token punctuation">;</span>  

    move<span class="token operator">-</span>result<span class="token operator">-</span>object p4  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p1<span class="token punctuation">,</span> p4<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>text<span class="token operator">/</span><span class="token class-name">SimpleDateFormat</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">Object</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span>  

    move<span class="token operator">-</span>result<span class="token operator">-</span>object p1  

    check<span class="token operator">-</span>cast p1<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>  

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p2<span class="token punctuation">,</span> p1<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>  

    <span class="token punctuation">.</span>line <span class="token number">35</span>  
    <span class="token operator">:</span>goto_6d  
    iget p0<span class="token punctuation">,</span> p0<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>ui<span class="token operator">/</span><span class="token class-name">SmaliLearn</span><span class="token punctuation">;</span><span class="token operator">-></span>vip_coin<span class="token operator">:</span><span class="token class-name">I</span>  

    <span class="token keyword">if</span><span class="token operator">-</span>eqz p0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_74  

    <span class="token punctuation">.</span>line <span class="token number">36</span>  
    invoke<span class="token operator">-</span><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span>

    move<span class="token operator">-</span>result<span class="token operator">-</span>object p0

    check<span class="token operator">-</span>cast p0<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>

    invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p3<span class="token punctuation">,</span> p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span>

    <span class="token operator">:</span>cond_74  
    <span class="token keyword">return</span><span class="token operator">-</span><span class="token keyword">void</span>  
<span class="token punctuation">.</span>end method<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>const&#x2F;4和const&#x2F;16的区别？<br><strong>4代表4字节</strong><br><strong>16代表16字节</strong></p>
<h3 id="2-Long型赋值"><a href="#2-Long型赋值" class="headerlink" title="2.Long型赋值"></a>2.Long型赋值</h3><p><strong>const-wide vx, lit32</strong> 表示将一个 32 位的常量存储到 vx 与 vx+1 两个寄存器中 —— 即一个 long 类型的数据</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token punctuation">.</span>method <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token function">vipEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token class-name">J</span>  
    <span class="token punctuation">.</span>registers <span class="token number">3</span>  

    <span class="token keyword">const</span><span class="token operator">-</span>wide v0<span class="token punctuation">,</span> <span class="token number">0</span>x1854460ef29L  

    <span class="token keyword">return</span><span class="token operator">-</span>wide v0  
<span class="token punctuation">.</span>end method<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>会员到期时间就是2022年12月24日。那么1854460ef29L 怎么来的呢？也就是（2022年12月24日-1970年1月1日）×365天×24小时×60分钟×60秒×1000毫秒，转换成16进制就大概是那个数了</p>
<p>在线时间戳转换</p>
<h3 id="3-变量赋值-正则"><a href="#3-变量赋值-正则" class="headerlink" title="3.变量赋值(正则)"></a>3.变量赋值(正则)</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java">    iget p0<span class="token punctuation">,</span> p0<span class="token punctuation">,</span> <span class="token class-name">Lcom</span><span class="token operator">/</span>zj<span class="token operator">/</span>wuaipojie<span class="token operator">/</span>ui<span class="token operator">/</span><span class="token class-name">SmaliLearn</span><span class="token punctuation">;</span><span class="token operator">-></span>vip_coin<span class="token operator">:</span><span class="token class-name">I</span>  

<span class="token keyword">if</span><span class="token operator">-</span>eqz p0<span class="token punctuation">,</span> <span class="token operator">:</span>cond_74  

<span class="token punctuation">.</span>line <span class="token number">36</span>  
invoke<span class="token operator">-</span><span class="token keyword">static</span> <span class="token punctuation">&#123;</span>p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">I</span><span class="token punctuation">)</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">String</span><span class="token punctuation">;</span>

move<span class="token operator">-</span>result<span class="token operator">-</span>object p0

check<span class="token operator">-</span>cast p0<span class="token punctuation">,</span> <span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span>

invoke<span class="token operator">-</span>virtual <span class="token punctuation">&#123;</span>p3<span class="token punctuation">,</span> p0<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token class-name">Landroid</span><span class="token operator">/</span>widget<span class="token operator">/</span><span class="token class-name">TextView</span><span class="token punctuation">;</span><span class="token operator">-></span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token class-name">Ljava</span><span class="token operator">/</span>lang<span class="token operator">/</span><span class="token class-name">CharSequence</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token class-name">V</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="/./../img/640-1695707504006-70.png" alt="图片"></p>
<pre class="line-numbers language-none"><code class="language-none">(.*) .*
const&#x2F;4 $1 0x1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="9-反思"><a href="#9-反思" class="headerlink" title="9.反思"></a>9.反思</h2><p>签名的博弈日新月异，善用工具，拥抱开源！！！</p>
<p>通过系统自带的api去获取签名很容易被伪造，不妨试试通过SVC的方式去获取(参考MT开源的方法)<br>隐式签名校验<br>有一些则比较隐晦，在发现apk被修改后，会偷偷修改apk的部分功能，例如在某些多开定位软件中，会暗改ip的经纬网等，跟实际产生一定的偏差。<br>PS:推荐学习芽衣大神的手撕签名校验教程<br><img src="/./../img/640-1695707504006-71.png" alt="图片"></p>
<p>点击学习</p>
<h1 id="四、课后小作业"><a href="#四、课后小作业" class="headerlink" title="四、课后小作业"></a>四、课后小作业</h1><hr>
<p>1.手动实现PM代理<br>2.移植我的重定向代码(要学会偷代码！)<br><img src="/./../img/640-1695707504006-72.png" alt="图片"></p>
<p>3.完成作业demo<br><a target="_blank" rel="noopener" href="https://wwqi.lanzoub.com/iKt5G0jkvhtc">https://wwqi.lanzoub.com/iKt5G0jkvhtc</a></p>
<p>作业反馈贴（前50名交作业有奖励）</p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1731203-1-1.html">https://www.52pojie.cn/thread-1731203-1-1.html</a></p>
<h1 id="五、答疑"><a href="#五、答疑" class="headerlink" title="五、答疑"></a>五、答疑</h1><hr>
<p>待更新</p>
<h1 id="六、视频及课件地址"><a href="#六、视频及课件地址" class="headerlink" title="六、视频及课件地址"></a>六、视频及课件地址</h1><hr>
<p>百度云：</p>
<p><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1cFWTLn14jeWfpXxlx3syYw?pwd=nqu9">https://pan.baidu.com/s/1cFWTLn14jeWfpXxlx3syYw?pwd=nqu9</a></p>
<p>阿里云PS：</p>
<p><a target="_blank" rel="noopener" href="https://www.aliyundrive.com/s/TJoKMK6du6x">https://www.aliyundrive.com/s/TJoKMK6du6x</a></p>
<p>哔哩哔哩：</p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1X24y1m7cj">https://www.bilibili.com/video/BV1X24y1m7cj</a></p>
<p>PS:解压密码都是52pj，阿里云由于不能分享压缩包，所以下载exe文件，双击自解压</p>
<h1 id="七、其他章节"><a href="#七、其他章节" class="headerlink" title="七、其他章节"></a>七、其他章节</h1><hr>
<p><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5Mjc3MDM2Mw==&mid=2651138475&idx=1&sn=e3c5242b7c51f022fcc0efb7f626ab61&chksm=bd50b9ff8a2730e9484df2faa08ed63c1980d5f230b69200450917b0daae1904505c878daca8&scene=21#wechat_redirect">《安卓逆向这档事》一、模拟器环境搭建</a><br><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5Mjc3MDM2Mw==&mid=2651138483&idx=1&sn=efa7eabbf0b0cc637a0ccdf8dd62abe5&chksm=bd50b9e78a2730f1f994976f36a60dd8390c4920396b8aec2052b4a666d91d18555096fc8172&scene=21#wechat_redirect">《安卓逆向这档事》二、初识APK安卓逆向这文件结构、双开、汉化、基础修改</a><br><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5Mjc3MDM2Mw==&mid=2651138541&idx=1&sn=c7482f59c3d830b2646e276761928941&chksm=bd50b9b98a2730af72e1f9e346663c12973821967c1ac002f5fcdabd0182af5f6106b36d6a01&scene=21#wechat_redirect">《安卓逆向这档事》第三课、初识smail，vip终结者</a><br><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5Mjc3MDM2Mw==&mid=2651138554&idx=1&sn=be2fe7ffb0520ef17405a754ff0725c8&chksm=bd50b9ae8a2730b84d054c7bd903f8a066251266e16cb1438999759797383e6f20aa656fbbff&scene=21#wechat_redirect">《安卓逆向这档事》四、恭喜你获得广告&amp;弹窗静默卡</a><br><a target="_blank" rel="noopener" href="http://mp.weixin.qq.com/s?__biz=MjM5Mjc3MDM2Mw==&mid=2651138674&idx=1&sn=17a3271b1771bdacf3392fb64dcc5dc3&chksm=bd50ba268a273330bea4fd1804afff15b9308ed53c88d9aa26a363da0bdeff63642fcce3a42b&scene=21#wechat_redirect">《安卓逆向这档事》五、1000-7&#x3D;？&amp;动态调试&amp;Log插桩</a></p>
<h1 id="八、参考文档"><a href="#八、参考文档" class="headerlink" title="八、参考文档"></a>八、参考文档</h1><hr>
<p>APK 签名：v1 v2 v3 v4<br>如何把签名校验做到极致<br>Android PMS HOOK<br>[实战破解]白描-动态代理Hook签名校验<br>[原创]对安卓反调试和校验检测的一些实践与结论<br>新版MT去签及对抗<br>【小白教程】正则匹配的写法 多行匹配 批量赋值 smali逆向 简单实用</p>
<p>详细文字介绍、视频原件下载、视频所用到的程序下载、课后作业和学习交流参看论坛原文：</p>
<p><a target="_blank" rel="noopener" href="https://www.52pojie.cn/thread-1731181-1-1.html">https://www.52pojie.cn/thread-1731181-1-1.html</a></p>
</div>
        </div>
        
            <div class="kratos-copyright text-center clearfix">
                <h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5>
            </div>
        
        <footer class="kratos-entry-footer clearfix">
            
                <div class="post-like-donate text-center clearfix" id="post-like-donate">
                
                
                    <a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a>
                    <div class="share-wrap" style="display: none;">
    <div class="share-group">
        <a href="javascript:;" class="share-plain qq" onclick="share('qq');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-qq"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain qzone" onclick="share('qzone');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-star"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weixin"></i>
            </div>
            <div class="share-int">
                <div class="qrcode" id="wechat-qr"></div>
                <p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p>
            </div>
        </a>
        <a href="javascript:;" class="share-plain weibo" onclick="share('weibo');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-weibo"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain facebook style-plain" onclick="share('facebook');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-facebook"></i>
            </div>
        </a>
        <a href="javascript:;" class="share-plain twitter style-plain" onclick="share('twitter');" rel="nofollow">
            <div class="icon-wrap">
                <i class="fa fa-twitter"></i>
            </div>
        </a>
    </div>
    <script type="text/javascript">
        $(()=>{
            new QRCode("wechat-qr", {
                text: "https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E8%BF%99%E6%A1%A3%E4%BA%8B(6)%E3%80%81%E6%A0%A1%E9%AA%8C%E7%9A%84N%E6%AC%A1%E6%96%B9-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%AF%B9%E6%8A%97%E3%80%81PM%E7%90%86%E3%80%81IO%E9%87%8D%E5%AE%9A%E5%90%91/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://hexodd-9go6c0x4h-dongdonga11.vercel.app/2023/09/27/app%E9%80%86%E5%90%91/%E5%AE%89%E5%8D%93%E9%80%86%E5%90%91%E8%BF%99%E6%A1%A3%E4%BA%8B(6)%E3%80%81%E6%A0%A1%E9%AA%8C%E7%9A%84N%E6%AC%A1%E6%96%B9-%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E5%AF%B9%E6%8A%97%E3%80%81PM%E7%90%86%E3%80%81IO%E9%87%8D%E5%AE%9A%E5%90%91/";
            const title         = "「吾爱破解安卓逆向入门教程《安卓逆向这档事》六、校验的N次方-签名校验对抗、PM理、IO重定向」";
            const excerpt       = `
一、课程目标
1.了解APK文件签名2.了解APK常见校验及校验对抗方法3.了解PM代理和IO重定向4.smali语法之赋值
二、工具
1.教程Demo(更新)2.MT管理器&#x2F;NP管理器3.雷电模拟器4.Jadx-gui(...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };
    </script>
</div>
                
                </div>
            
            <div class="footer-tag clearfix">
                <div class="pull-left">
                <i class="fa fa-tags"></i>
                    <a class="tag-none-link" href="/tags/APP%E9%80%86%E5%90%91/" rel="tag">APP逆向</a>, <a class="tag-none-link" href="/tags/android%E9%80%86%E5%90%91/" rel="tag">android逆向</a>, <a class="tag-none-link" href="/tags/%E5%90%BE%E7%88%B1%E7%A0%B4%E8%A7%A3%E6%95%99%E7%A8%8B10%E8%8A%82/" rel="tag">吾爱破解教程10节</a>, <a class="tag-none-link" href="/tags/%E5%A4%A7%E9%BA%A6%E7%BD%91%E6%8A%A2%E7%A5%A8/" rel="tag">大麦网抢票</a>, <a class="tag-none-link" href="/tags/%E9%80%86%E5%90%91/" rel="tag">逆向</a>
                </div>
                <div class="pull-date">
                    <time datetime="2023-09-27T06:16:29.946Z" itemprop="dateModified">最后编辑：2023-09-27</time>
                </div>
            </div>
        </footer>
    </div>
    
        <nav class="navigation post-navigation clearfix" role="navigation">
            
            <div class="nav-previous clearfix">
                <a title=" 吾爱破解安卓逆向入门教程《安卓逆向这档事》七、会Hook真的可以为所欲为-xposed快速上手(上)模块编写" href="/2023/09/27/app逆向/安卓逆向这档事(7)、Sorry，会Hook真的可以为所欲为-xposed快速上手(上)模块编写/">&lt; 上一篇</a>
            </div>
            
            
            <div class="nav-next clearfix">
                <a title=" 《安卓逆向这档事》五、1000-7=？&amp;动态调试&amp;Log插桩" href="/2023/09/27/app逆向/安卓逆向这档事(5)、1000-7=？&动态调试&Log插桩/">下一篇 &gt;</a>
            </div>
            
        </nav>
    
    
</article>

        

            </section>

        

                
            

<section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm">
    <!-- 文章和页面根据splitter来分割，没有的话就从头开始设置为sticky -->
    
    
                <aside id="krw-about" class="widget widget-kratos-about clearfix">
    <div class="photo-background"></div>
    <div class="photo-wrapper clearfix">
        <div class="photo-wrapper-tip text-center">
            <img class="about-photo" src="/images/about.webp" loading="lazy" decoding="auto" />
        </div>
    </div>
    <div class="textwidget">
        <p class="text-center">分享学习的文章分享基地</p>
    </div>
    <div class="site-meta">
        <a class="meta-item" href="/archives/">
            <span class="title">
                文章
            </span>
            <span class="count">
                66
            </span>
        </a>
        <a class="meta-item" href="/categories/">
            <span class="title">
                分类
            </span>
            <span class="count">
                6
            </span>
        </a>
        <a class="meta-item" href="/tags/">
            <span class="title">
                标签
            </span>
            <span class="count">
                39
            </span>
        </a>
    </div>
</aside>
            
                    <div class="sticky-area">
                
                
  <aside id="krw-categories" class="widget widget-kratos-categories clearfix">
    <h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4>
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/chatgpt/">chatgpt</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/excel/">excel</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/github/">github</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vba-access/">vba-access</a><span class="category-list-count">29</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%88%AC%E8%99%AB%E9%80%86%E5%90%91/">爬虫逆向</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E6%97%A5%E8%AE%B0/">项目日记</a><span class="category-list-count">3</span></li></ul>
  </aside>


            
                
  <aside id="krw-tags" class="widget widget-kratos-tags clearfix">
    <h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4>
      <div class="tag-clouds">
        <a href="/tags/APP%E9%80%86%E5%90%91/" style="font-size: 0.74em;">APP逆向</a> <a href="/tags/ChatGPT/" style="font-size: 0.63em;">ChatGPT</a> <a href="/tags/access/" style="font-size: 0.77em;">access</a> <a href="/tags/android%E9%80%86%E5%90%91/" style="font-size: 0.71em;">android逆向</a> <a href="/tags/chrom/" style="font-size: 0.6em;">chrom</a> <a href="/tags/excel/" style="font-size: 0.8em;">excel</a> <a href="/tags/excel-access-vba/" style="font-size: 0.6em;">excel - access - vba</a> <a href="/tags/github/" style="font-size: 0.63em;">github</a> <a href="/tags/hexo/" style="font-size: 0.6em;">hexo</a> <a href="/tags/ideas/" style="font-size: 0.63em;">ideas</a> <a href="/tags/markdown/" style="font-size: 0.6em;">markdown</a> <a href="/tags/pandas/" style="font-size: 0.6em;">pandas</a> <a href="/tags/vba/" style="font-size: 0.8em;">vba</a> <a href="/tags/vercel/" style="font-size: 0.6em;">vercel</a> <a href="/tags/vervel/" style="font-size: 0.6em;">vervel</a> <a href="/tags/%E5%88%97%E8%A1%A8%E6%A1%86/" style="font-size: 0.66em;">列表框</a> <a href="/tags/%E5%90%BE%E7%88%B1%E7%A0%B4%E8%A7%A3%E6%95%99%E7%A8%8B10%E8%8A%82/" style="font-size: 0.69em;">吾爱破解教程10节</a> <a href="/tags/%E5%9F%9F%E5%90%8D/" style="font-size: 0.6em;">域名</a>
      </div>
  </aside>

            
                
  <aside id="krw-posts" class="widget widget-kratos-posts">
  <h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4>
  <div class="tab-content">
      <ul class="list-group">
        
        
          
          
            <a class="list-group-item" href="/2023/09/27/app%E9%80%86%E5%90%91/%E5%A4%A7%E9%BA%A6%E7%BD%91%E6%8A%A2%E7%A5%A8%E8%BD%AF%E4%BB%B6%E5%B7%A5%E5%85%B7%E5%BC%80%E5%8F%91%E7%B3%BB%E5%88%97%EF%BC%88%E4%B8%80%EF%BC%89/"><i class="fa  fa-book"></i> 大麦网抢票软件工具开发系列（一）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/09/27/app%E9%80%86%E5%90%91/%E9%98%BF%E9%87%8C%E7%B3%BBApp%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/"><i class="fa  fa-book"></i> 阿里系App抓包分析（一）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/09/27/app%E9%80%86%E5%90%91/%E9%98%BF%E9%87%8C%E7%B3%BBApp%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/"><i class="fa  fa-book"></i> 阿里系App抓包分析（三）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/09/27/app%E9%80%86%E5%90%91/%E9%98%BF%E9%87%8C%E7%B3%BBApp%E6%8A%93%E5%8C%85%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/"><i class="fa  fa-book"></i> 阿里系App抓包分析（二）</a>
            
          
        
          
          
            <a class="list-group-item" href="/2023/09/27/Android%E9%80%86%E5%90%91-%E6%9F%90%E9%BA%A6%E7%BD%91APK%E6%8A%A2%E7%A5%A8%E6%8E%A5%E5%8F%A3%E5%8A%A0%E5%AF%86%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90/"><i class="fa  fa-book"></i> Android逆向-某麦网APK抢票接口加密参数分析</a>
            
          
        
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
          
            
      </ul>
  </div>
  </aside>

            
    </div>
</section>
        
        </div>
    </div>
</div>
<footer>
    <div id="footer"  class="ap-lrc"  >
        <div class="container">
            <div class="row">
                <div class="col-md-6 col-md-offset-3 footer-list text-center">
                    <ul class="kratos-social-icons">
                        <!-- Keep for compatibility -->
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <!-- New links -->
                        
                    </ul>
                    <ul class="kratos-copyright">
                        <div>
                            <li>&copy; 2023 栋栋的个人博客 版权所有.</li>
                            <li>本站已运行<span id="span_dt">Loading...</span></li>
                        </div>
                        <div>
                            <li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li>
                            <li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by John DD.</li>
                        </div>
                        <div>
                            <li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li>
                            <li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li>
                        </div>
                        <div>
                            
                            
                        </div>
                    </ul>
                </div>
            </div>
        </div>
        <div class="kr-tool text-center">
            <div class="tool">
                
                    <div class="box search-box">
                        <a href="/search/">
                            <span class="fa fa-search"></span>
                        </a>
                    </div>
                
                
                    <div class="box theme-box" id="darkmode-switch">
                        <span class="fa fa-adjust"></span>
                    </div>
                
                
                
            </div>
            <div class="box gotop-box">
                <span class="fa fa-chevron-up"></span>
            </div>
        </div>
    </div>
</footer>
</div>
</div>

        <script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script>
<script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script>
<script>
    if (!window.kr) {
        window.kr = {};
    }
    window.kr.notMobile = (!(navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i)));
    window.kr.siteRoot = "/";
</script>




    <script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script>
    
    <script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script>
    <meting-js
        server="netease"
        type="playlist"
        id="3204190542"
        order="random"
        fixed="true"
    >
    </meting-js>



    <script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

<script defer src="/js/kratosr.min.js"></script>
<script defer src="/js/pjax.min.js"></script>



<!-- Extra support for third-party plguins  -->


    </body>
</html>